<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Java äº‘åŸç”Ÿ BootCamp Day 2 æ“ä½œæ‰‹å†Œ](#java-%E4%BA%91%E5%8E%9F%E7%94%9F-bootcamp-day-2-%E6%93%8D%E4%BD%9C%E6%89%8B%E5%86%8C)
  - [é˜¶æ®µä¸€ï¼šVPC ç½‘ç»œé…ç½®](#%E9%98%B6%E6%AE%B5%E4%B8%80vpc-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE)
      - [æ“ä½œç›®çš„ä¸èƒŒæ™¯](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF)
      - [æ“ä½œæ­¥éª¤](#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4)
      - [éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º](#%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%BE%93%E5%87%BA)
      - [å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%B8%8E%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95troubleshooting)
      - [âœ… é˜¶æ®µä¸€éªŒæ”¶æ¸…å•](#-%E9%98%B6%E6%AE%B5%E4%B8%80%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95)
  - [é˜¶æ®µäºŒï¼šALB åˆ›å»ºä¸åŸŸåé…ç½®](#%E9%98%B6%E6%AE%B5%E4%BA%8Calb-%E5%88%9B%E5%BB%BA%E4%B8%8E%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE)
      - [æ“ä½œç›®çš„ä¸èƒŒæ™¯](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-1)
      - [æ“ä½œæ­¥éª¤](#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4-1)
      - [éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º](#%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%BE%93%E5%87%BA-1)
      - [å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%B8%8E%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95troubleshooting-1)
      - [âœ… é˜¶æ®µäºŒéªŒæ”¶æ¸…å•](#-%E9%98%B6%E6%AE%B5%E4%BA%8C%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95)
  - [é˜¶æ®µä¸‰ï¼šIAM æƒé™é…ç½®](#%E9%98%B6%E6%AE%B5%E4%B8%89iam-%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE)
      - [æ“ä½œç›®çš„ä¸èƒŒæ™¯](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-2)
      - [æ“ä½œæ­¥éª¤](#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4-2)
      - [éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º](#%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%BE%93%E5%87%BA-2)
      - [å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%B8%8E%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95troubleshooting-2)
      - [âœ… é˜¶æ®µä¸‰éªŒæ”¶æ¸…å•](#-%E9%98%B6%E6%AE%B5%E4%B8%89%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95)
  - [é˜¶æ®µå››ï¼šEKS é›†ç¾¤éƒ¨ç½²](#%E9%98%B6%E6%AE%B5%E5%9B%9Beks-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2)
      - [æ“ä½œç›®çš„ä¸èƒŒæ™¯](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-3)
      - [æ“ä½œæ­¥éª¤](#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4-3)
      - [éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º](#%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%BE%93%E5%87%BA-3)
      - [å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%B8%8E%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95troubleshooting-3)
      - [âœ… é˜¶æ®µå››éªŒæ”¶æ¸…å•](#-%E9%98%B6%E6%AE%B5%E5%9B%9B%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95)
  - [é˜¶æ®µäº”ï¼šTerraform èµ„æºå¯¼å…¥](#%E9%98%B6%E6%AE%B5%E4%BA%94terraform-%E8%B5%84%E6%BA%90%E5%AF%BC%E5%85%A5)
      - [æ“ä½œç›®çš„ä¸èƒŒæ™¯](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-4)
      - [æ“ä½œæ­¥éª¤](#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4-4)
      - [éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º](#%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%BE%93%E5%87%BA-4)
      - [å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%B8%8E%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95troubleshooting-4)
      - [âœ… é˜¶æ®µäº”éªŒæ”¶æ¸…å•](#-%E9%98%B6%E6%AE%B5%E4%BA%94%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95)
  - [é˜¶æ®µå…­ï¼šCluster Autoscaler å®‰è£…](#%E9%98%B6%E6%AE%B5%E5%85%ADcluster-autoscaler-%E5%AE%89%E8%A3%85)
      - [æ“ä½œç›®çš„ä¸èƒŒæ™¯](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-5)
      - [æ“ä½œæ­¥éª¤](#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4-5)
      - [éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º](#%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%BE%93%E5%87%BA-5)
      - [å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%B8%8E%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95troubleshooting-5)
      - [âœ… é˜¶æ®µå…­éªŒæ”¶æ¸…å•](#-%E9%98%B6%E6%AE%B5%E5%85%AD%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95)
  - [é˜¶æ®µä¸ƒï¼šç¯å¢ƒå…³åœä¸æ¸…ç†ï¼ˆå¯é€‰ï¼‰](#%E9%98%B6%E6%AE%B5%E4%B8%83%E7%8E%AF%E5%A2%83%E5%85%B3%E5%81%9C%E4%B8%8E%E6%B8%85%E7%90%86%E5%8F%AF%E9%80%89)
      - [æ“ä½œç›®çš„ä¸èƒŒæ™¯](#%E6%93%8D%E4%BD%9C%E7%9B%AE%E7%9A%84%E4%B8%8E%E8%83%8C%E6%99%AF-6)
      - [æ“ä½œæ­¥éª¤](#%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4-6)
      - [éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º](#%E9%AA%8C%E8%AF%81%E5%91%BD%E4%BB%A4%E4%B8%8E%E9%A2%84%E6%9C%9F%E8%BE%93%E5%87%BA-6)
      - [å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰](#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E6%8F%90%E7%A4%BA%E4%B8%8E%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95troubleshooting-6)
      - [âœ… é˜¶æ®µä¸ƒéªŒæ”¶æ¸…å•](#-%E9%98%B6%E6%AE%B5%E4%B8%83%E9%AA%8C%E6%94%B6%E6%B8%85%E5%8D%95)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# Java äº‘åŸç”Ÿ BootCamp Day 2 æ“ä½œæ‰‹å†Œ

**æœ€åæ›´æ–°ï¼š** 2025 å¹´ 6 æœˆ 28 æ—¥

æœ¬æ“ä½œæ‰‹å†Œæ—¨åœ¨æŒ‡å¯¼ Java äº‘åŸç”Ÿ BootCamp æ¯æ—¥å¯¹ AWS EKS é›†ç¾¤ç¯å¢ƒè¿›è¡Œä» **åˆ›å»º** åˆ° **é”€æ¯** çš„å…¨æµç¨‹ç»ƒä¹ ã€‚é€šè¿‡åˆ†é˜¶æ®µçš„æ˜ç¡®æ­¥éª¤ï¼Œæ‚¨å°†ä½¿ç”¨ **Terraform**ã€**AWS CLI**ã€**eksctl** ç­‰å·¥å…·ï¼Œä»¥ **CLI æ“ä½œä¸ºä¸»** å®Œæˆ VPC ç½‘ç»œéƒ¨ç½²ã€ALB åˆ›å»ºã€IAM è§’è‰²é…ç½®ã€EKS é›†ç¾¤æ­å»ºã€Cluster Autoscaler å®‰è£…ä»¥åŠ Terraform èµ„æºå¯¼å…¥ç­‰ä»»åŠ¡ã€‚åœ¨æ¯ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬æä¾›æ“ä½œèƒŒæ™¯ï¼ˆä¸­è‹±æ··åˆè¯´æ˜ï¼‰ã€ç²¾ç¡®çš„ CLI å‘½ä»¤æ­¥éª¤ï¼ˆå¿…è¦æ—¶æŒ‡æ˜ AWS æ§åˆ¶å°æ“ä½œï¼‰ã€éªŒè¯æ–¹æ³•åŠé¢„æœŸç»“æœï¼Œä»¥åŠå¸¸è§é”™è¯¯çš„æ•…éšœæ’é™¤æç¤ºï¼Œæœ€åä»¥ âœ… **éªŒæ”¶æ¸…å•** å¸®åŠ©æ‚¨ç¡®è®¤é˜¶æ®µç›®æ ‡æ˜¯å¦é¡ºåˆ©è¾¾æˆã€‚è¯·åœ¨å¼€å§‹ä¹‹å‰ç¡®ä¿å·²æ»¡è¶³å‰ç½®æ¡ä»¶ï¼ŒåŒ…æ‹¬æ­£ç¡®é…ç½® AWS å‡­è¯ä¸ Terraform è¿œç«¯çŠ¶æ€ç­‰ã€‚

> **æç¤ºï¼š** ä»¥ä¸‹æ¼”ç»ƒå‡å®š AWS åŒºåŸŸä¸º **`us-east-1`**ï¼ŒAWS CLI Profile ä¸º **`phase2-sso`**ï¼ŒTerraform è¿œç«¯çŠ¶æ€ä¿å­˜åœ¨ S3 Bucket **`phase2-tf-state-us-east-1`** å’Œ DynamoDB è¡¨ **`tf-state-lock`**ã€‚EKS é›†ç¾¤åç§°é»˜è®¤ä¸º **`dev`**ï¼ŒRouteÂ 53 æ‰˜ç®¡åŒºåŸŸï¼ˆHosted Zoneï¼‰å‡å®šä¸º **`lab.rendazhang.com`**ã€‚å¦‚æœ‰ä¸åŒç¯å¢ƒé…ç½®ï¼Œè¯·é…Œæƒ…æ›¿æ¢æ–‡ä¸­çš„å‚æ•°å€¼ã€‚

## é˜¶æ®µä¸€ï¼šVPC ç½‘ç»œé…ç½®

#### æ“ä½œç›®çš„ä¸èƒŒæ™¯

åœ¨å¼€å§‹éƒ¨ç½² EKS é›†ç¾¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ­å»ºåŸºæœ¬çš„ç½‘ç»œç¯å¢ƒã€‚æ­¤é˜¶æ®µå°†ä½¿ç”¨ **Terraform** åˆ›å»ºä¸€ä¸ªæ–°çš„ **VPCï¼ˆVirtual Private Cloudï¼‰** åŠå…¶å­ç½‘ã€è·¯ç”±è¡¨å’Œ **NAT ç½‘å…³**ï¼Œä¸º EKS é›†ç¾¤æä¾›éš”ç¦»çš„ç½‘ç»œç©ºé—´å’Œäº’è”ç½‘å‡ºå£ã€‚VPC ä¼šåˆ’åˆ†è‹¥å¹² **å…¬æœ‰å­ç½‘**ï¼ˆæ‰¿è½½ ALB ç­‰å…¬ç½‘èµ„æºï¼‰å’Œ **ç§æœ‰å­ç½‘**ï¼ˆæ‰¿è½½ EKS å·¥ä½œèŠ‚ç‚¹ç­‰éœ€éš”ç¦»çš„èµ„æºï¼‰ï¼Œå¹¶é…ç½® NAT Gateway ä¾›ç§æœ‰å­ç½‘å†…çš„å®ä¾‹è®¿é—®å¤–éƒ¨ç½‘ç»œã€‚é€šè¿‡æ ‡å‡†åŒ–çš„ç½‘ç»œæ‹“æ‰‘ï¼Œç¡®ä¿åç»­å„é˜¶æ®µç»„ä»¶æœ‰è‰¯å¥½çš„åŸºç¡€è¿æ¥ã€‚*ï¼ˆæœ¯è¯­æç¤ºï¼šVPCã€Subnetã€Route Tableã€NAT Gateway ç­‰ä¿æŒè‹±æ–‡ï¼Œä»¥æ–¹ä¾¿å¯¹åº” AWS æ§åˆ¶å°ç•Œé¢ï¼‰*

#### æ“ä½œæ­¥éª¤

1. **åˆå§‹åŒ– Terraform åç«¯**ï¼šæ‰“å¼€ç»ˆç«¯ï¼Œåˆ‡æ¢åˆ°é¡¹ç›® `infra/aws` ç›®å½•ï¼Œå¹¶æ‰§è¡Œ Terraform åˆå§‹åŒ–å‘½ä»¤ã€‚è¿™ä¼šé…ç½®è¿œç¨‹çŠ¶æ€å­˜å‚¨åç«¯ï¼ˆä½¿ç”¨æ‚¨é¢„å…ˆåˆ›å»ºçš„ S3 Bucket å’Œ DynamoDB è¡¨ï¼‰ï¼š

   ```bash
   cd infra/aws
   terraform init -reconfigure
   ```

   å¦‚æœå‡ºç° `NoSuchBucket` æˆ– `ResourceNotFoundException` é”™è¯¯ï¼Œè¯´æ˜ Terraform åç«¯çš„ S3 Bucket æˆ– DynamoDB é”è¡¨ä¸å­˜åœ¨ã€‚è¯·å…ˆæ ¹æ®é…ç½®åˆ›å»º Bucket å’Œè¡¨ï¼Œç„¶åé‡è¯•åˆå§‹åŒ–ï¼ˆæˆ–åœ¨ `backend.tf` æ–‡ä»¶ä¸­æ›´æ–°ä¸ºæ­£ç¡®åç§°ï¼‰ã€‚

1. **æ£€æŸ¥ Terraform è®¡åˆ’**ï¼šå¯é€‰æ­¥éª¤ï¼Œæ‰§è¡Œ Terraform Plan æŸ¥çœ‹å°†è¦åˆ›å»ºçš„èµ„æºåˆ—è¡¨ï¼Œç¡®ä¿é…ç½®ç¬¦åˆé¢„æœŸï¼š

   ```bash
   terraform plan -var="region=us-east-1"
   ```

   Terraform ä¼šåˆ—å‡ºå³å°†åˆ›å»ºçš„ VPCã€å­ç½‘ã€Internet Gatewayã€Route Table ç­‰èµ„æºæ¸…å•åŠæ•°é‡ã€‚æ ¸å¯¹è¾“å‡ºä¸­ VPC CIDRã€å­ç½‘æ•°é‡å’Œ NAT Gateway æ•°é‡æ˜¯å¦ç¬¦åˆè®¾è®¡ã€‚å¦‚æœè®¡åˆ’æœ‰è¯¯ï¼Œå¯è°ƒæ•´ `terraform.tfvars` é…ç½®åé‡æ–°è¿è¡Œè®¡åˆ’ã€‚*ï¼ˆæ³¨æ„ï¼šé»˜è®¤ VPC CIDR å¦‚æœªæ˜¾å¼è®¾ç½®ï¼Œä¸€èˆ¬ä¸º AWS éšæœºç”Ÿæˆæˆ–æ¨¡å—é»˜è®¤å€¼ï¼›å¯æ ¹æ®éœ€è¦åœ¨ vars æ–‡ä»¶ä¸­æŒ‡å®šã€‚ï¼‰*

1. **åº”ç”¨ Terraform é…ç½®**ï¼šç¡®è®¤è®¡åˆ’æ— è¯¯åï¼Œæ‰§è¡Œ Terraform Apply æ¥åˆ›å»ºç½‘ç»œåŸºç¡€è®¾æ–½ã€‚æ­¤å‘½ä»¤å°†è‡ªåŠ¨åˆ›å»º VPC åŠç›¸å…³èµ„æºï¼š

   ```bash
   terraform apply -auto-approve -var="region=us-east-1"
   ```

   > **è¯´æ˜ï¼š** æœ¬é¡¹ç›® Terraform è„šæœ¬é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¼šåŒæ—¶åˆ›å»º VPCã€å­ç½‘ã€è·¯ç”±ã€NAT Gateway ç­‰èµ„æºã€‚å…¶ä¸­ NAT Gateway ç”±å˜é‡ `create_nat` æ§åˆ¶ï¼Œé»˜è®¤ä¸º `true`ã€‚å¦‚éœ€æš‚æ—¶è·³è¿‡ NAT éƒ¨ç½²ï¼Œå¯å°†è¯¥å˜é‡è®¾ä¸º false å†æ‰§è¡Œã€‚ä½†åœ¨æ ‡å‡†æ¼”ç»ƒä¸­ä¿æŒé»˜è®¤å¼€å¯ï¼Œä»¥ç¡®ä¿ç§æœ‰å­ç½‘æ‹¥æœ‰äº’è”ç½‘è®¿é—®èƒ½åŠ›ã€‚

1. **è¾“å‡ºæŸ¥çœ‹**ï¼šTerraform å®Œæˆåï¼Œå¯é€šè¿‡ Terraform è¾“å‡ºæˆ– AWS CLI éªŒè¯èµ„æºæ˜¯å¦æˆåŠŸåˆ›å»ºï¼š

   - æ‰§è¡Œ `terraform state list` æŸ¥çœ‹çŠ¶æ€æ–‡ä»¶ä¸­åº”åŒ…å« `aws_vpc`ã€`aws_subnet`ã€`aws_nat_gateway` ç­‰èµ„æºæ¡ç›®ã€‚

   - ä½¿ç”¨ AWS CLI éªŒè¯ VPC å’Œå­ç½‘ï¼š

     ```bash
     aws ec2 describe-vpcs --filters "Name=tag:Name,Values=*" --region us-east-1 --profile phase2-sso
     aws ec2 describe-subnets --filters "Name=vpc-id,Values=<VPC-ID>" --region us-east-1 --profile phase2-sso
     aws ec2 describe-nat-gateways --filter "Name=vpc-id,Values=<VPC-ID>" --region us-east-1 --profile phase2-sso
     ```

     å°† `<VPC-ID>` æ›¿æ¢ä¸ºå®é™…åˆ›å»ºçš„ VPC IDï¼ˆTerraform è¾“å‡ºæˆ– state æ–‡ä»¶ä¸­å¯æŸ¥ï¼‰ã€‚é¢„æœŸçœ‹åˆ° 1 ä¸ªæ–° VPCï¼Œè‹¥å¹²å­ç½‘ï¼ˆå…¬æœ‰/ç§æœ‰å„ 2 ä¸ªï¼‰ï¼Œä»¥åŠçŠ¶æ€ä¸º **available** çš„ NAT Gatewayã€‚

#### éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º

æ‰§è¡Œä¸Šè¿° CLI å‘½ä»¤åï¼Œé¢„æœŸè¾“å‡ºå¦‚ä¸‹ï¼š

- `describe-vpcs` è¿”å›åŒ…å«æ–°å»º VPC çš„åˆ—è¡¨ï¼Œå…¶ä¸­ `"State": "available"`ï¼ŒCIDR ä¸é…ç½®ç›¸ç¬¦ã€‚
- `describe-subnets` åˆ—å‡ºå±äºè¯¥ VPC çš„å­ç½‘ï¼Œæ•°é‡ä¸ Terraform é…ç½®ç›¸ç¬¦ï¼ˆä¾‹å¦‚å…¬æœ‰å­ç½‘å’Œç§æœ‰å­ç½‘å„ 2 ä¸ªï¼‰ã€‚æ¯ä¸ªå­ç½‘çš„ `"State": "available"` ä¸”æœ‰æ­£ç¡®çš„å¯ç”¨åŒº (`us-east-1a/1b`)ã€‚
- `describe-nat-gateways` è¿”å› NAT ç½‘å…³åˆ—è¡¨ï¼ŒåŒ…å«ä¸€ä¸ª **çŠ¶æ€ä¸º Available** ä¸” **å…³è”äº†å¼¹æ€§ IP (EIP)** çš„ NAT Gatewayã€‚

ç¤ºä¾‹è¾“å‡ºï¼ˆæ‘˜å½•ï¼‰ï¼š

```json
{
  "NatGateways": [
    {
      "NatGatewayId": "nat-0abcd123456ef7890",
      "State": "available",
      "VpcId": "vpc-0123abc45d678efgh",
      "SubnetId": "subnet-0ab1c2d3ef4567890",
      "NatGatewayAddresses": [
        {
          "PublicIp": "3.91.XX.XX",
          "AllocationId": "eipalloc-0abc123de456fgh78"
        }
      ]
    }
  ]
}
```

ä»¥ä¸Šè¾“å‡ºè¡¨ç¤º NAT Gateway å·²åˆ†é…å¼¹æ€§å…¬ç½‘ IPï¼Œå¹¶æˆåŠŸåˆ›å»ºäºç›¸åº” VPC çš„å…¬æœ‰å­ç½‘å†…ã€‚

#### å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰

- **æœªç™»å½• AWS æˆ–å‡­è¯æ— æ•ˆï¼š** å¦‚æœ Terraform æ‰§è¡ŒæŠ¥é”™ä¾‹å¦‚ *`ExpiredToken`* æˆ– *`Unable to locate credentials`*ï¼Œè¯·å…ˆé€šè¿‡ AWS SSO ç™»å½•æ‚¨çš„è´¦æˆ·ï¼Œç„¶åé‡è¯•å‘½ä»¤ã€‚å‘½ä»¤ç¤ºä¾‹ï¼š

  ```bash
  aws sso login --profile phase2-sso
  ```

  ç¡®è®¤ç™»å½•æˆåŠŸåå†è¿è¡Œ Terraform æ“ä½œã€‚

- **S3 Bucket/é”è¡¨ä¸å­˜åœ¨ï¼š** å¦‚æœ `terraform init` æŠ¥é”™æ‰¾ä¸åˆ° Bucket/DynamoDB è¡¨ï¼Œéœ€æŒ‰ç…§é…ç½®æ–‡ä»¶ä¸­çš„åç§°é¢„å…ˆåˆ›å»º**è¿œç«¯çŠ¶æ€å­˜å‚¨**èµ„æºã€‚æ‚¨å¯ä»¥é€šè¿‡ AWS ç®¡ç†æ§åˆ¶å°æˆ– AWS CLI æ–°å»ºæ‰€éœ€çš„ S3 å­˜å‚¨æ¡¶å’Œ DynamoDB è¡¨ï¼Œå¹¶ç¡®ä¿åç§°å®Œå…¨åŒ¹é…ã€‚

- **VPC æˆ–å­ç½‘é…é¢ä¸è¶³ï¼š** å¦‚æœ AWS è´¦æˆ·ä¸‹ VPC æ•°é‡å·²è¾¾ä¸Šé™ï¼ŒTerraform å¯èƒ½åˆ›å»ºå¤±è´¥ã€‚æ­¤æ—¶å¯é€‚å½“åˆ é™¤ä¸éœ€è¦çš„ VPCï¼Œæˆ–åœ¨ AWS æ§åˆ¶å°ç”³è¯·æå‡é…é¢ã€‚

- **NAT Gateway æ— æ³•åˆ›å»ºï¼š** NAT ç½‘å…³éœ€è¦å¼¹æ€§ IPï¼Œå¦‚å¼¹æ€§ IP é…é¢ä¸è¶³ï¼ˆé»˜è®¤æ¯åŒº 5 ä¸ªï¼‰ï¼Œä¹Ÿä¼šå¯¼è‡´é”™è¯¯ã€‚å¯é‡Šæ”¾é—²ç½® EIP æˆ–æé«˜é…é¢åé‡è¯•ã€‚

- **Terraform æç¤ºèµ„æºå†²çªï¼š** è‹¥æ—¥å¿—æ˜¾ç¤º VPC ID æˆ–å­ç½‘ CIDR å†²çªï¼Œå¯èƒ½æ˜¯é…ç½®ä¸å½“å¯¼è‡´ä¸ç°æœ‰ç½‘ç»œé‡å ã€‚è¯·è°ƒæ•´ Terraform VPC CIDRï¼ˆå¦‚ `10.0.0.0/16` ç­‰ä¸ä¸ç°æœ‰ç½‘æ®µå†²çªï¼‰åé‡æ–°éƒ¨ç½²ã€‚

#### âœ… é˜¶æ®µä¸€éªŒæ”¶æ¸…å•

- [ ] VPC å·²æˆåŠŸåˆ›å»ºï¼ŒçŠ¶æ€ä¸º *available*ï¼ŒCIDR è®¾ç½®æ­£ç¡®ï¼ˆæ— å†²çªï¼‰ã€‚
- [ ] æ¯ä¸ªå¯ç”¨åŒºå‡åˆ›å»ºäº†**å…¬æœ‰å­ç½‘**å’Œ**ç§æœ‰å­ç½‘**å„è‡³å°‘ 1 ä¸ªï¼Œå¹¶æ­£ç¡®å…³è”åˆ°æ–° VPCã€‚
- [ ] **Internet Gateway** å·²å…³è”åˆ°è¯¥ VPCï¼Œå…¬æœ‰å­ç½‘çš„è·¯ç”±è¡¨åŒ…å«ä¸€æ¡ 0.0.0.0/0 æŒ‡å‘ Internet Gateway çš„è·¯ç”±ã€‚
- [ ] **NAT Gateway** å·²åˆ›å»ºä¸”ä¸º *available* çŠ¶æ€ï¼Œç§æœ‰å­ç½‘çš„è·¯ç”±è¡¨åŒ…å«ä¸€æ¡ 0.0.0.0/0 æŒ‡å‘ NAT Gateway çš„è·¯ç”±ã€‚
- [ ] Terraform çŠ¶æ€æ–‡ä»¶ (`terraform.state`) ä¸­å­˜åœ¨ VPCã€Subnetã€NAT ç­‰èµ„æºè®°å½•ï¼Œä¸”æœªå‡ºç°ä»»ä½•é”™è¯¯ã€‚

---

## é˜¶æ®µäºŒï¼šALB åˆ›å»ºä¸åŸŸåé…ç½®

#### æ“ä½œç›®çš„ä¸èƒŒæ™¯

åœ¨å®ŒæˆåŸºç¡€ç½‘ç»œåï¼Œæœ¬é˜¶æ®µå°†éƒ¨ç½² **åº”ç”¨å‹è´Ÿè½½å‡è¡¡å™¨ï¼ˆALB, Application Load Balancerï¼‰** åŠå…¶é…å¥—èµ„æºï¼Œä¸ºé›†ç¾¤ä¸­çš„æœåŠ¡æä¾›å¯¹å¤–è®¿é—®å…¥å£ã€‚Terraform å°†æ ¹æ®éœ€è¦åˆ›å»º ALB ä»¥åŠå®‰å…¨ç»„ï¼Œå¹¶åœ¨ **RouteÂ 53** ä¸­åˆ›å»ºç›¸åº”çš„ DNS è®°å½•ï¼Œå°†å‹å¥½çš„åŸŸåæŒ‡å‘ ALBã€‚è¿™ä¸€é˜¶æ®µç¡®ä¿é›†ç¾¤å¯¹å¤–æœåŠ¡çš„æµé‡å…¥å£å°±ç»ªã€‚ç”±äº ALB æ˜¯å¯é€‰çš„é«˜æˆæœ¬èµ„æºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Terraform å¼€å…³çµæ´»å¯åœ ALB ä»¥èŠ‚çœè´¹ç”¨ï¼ˆç¨å Stop æ“ä½œä¸­ä¼šæ¶‰åŠï¼‰ã€‚åœ¨æ¯æ—¥æ¼”ç»ƒä¸­ï¼Œé€šå¸¸åœ¨å¯åŠ¨é›†ç¾¤å‰å¼€å¯ ALBï¼Œåœ¨åœæ­¢é›†ç¾¤æ—¶åˆ é™¤ ALBã€‚

#### æ“ä½œæ­¥éª¤

1. **å¯ç”¨ ALB èµ„æº**ï¼šåœ¨ `infra/aws/terraform.tfvars` æˆ–å‘½ä»¤è¡Œä¸­ç¡®ä¿å˜é‡ `create_alb` è®¾ç½®ä¸º `true`ã€‚é»˜è®¤é…ç½®å·²ç»å¼€å¯ ALB éƒ¨ç½²ã€‚å¦‚æœä¸Šä¸€é˜¶æ®µæœªåŒ…å« ALBï¼Œè¿™é‡Œå†æ¬¡æ‰§è¡Œ Terraform Apply å°†è¡¥å……éƒ¨ç½² ALBï¼š

   ```bash
   terraform apply -auto-approve -var="region=us-east-1" -var="create_alb=true"
   ```

   æ­¤æ“ä½œå°†åˆ›å»ºä¸€ä¸ª ALBï¼ˆåŒ…å«é»˜è®¤ç›‘å¬å™¨ï¼‰ã€å…³è”çš„å®‰å…¨ç»„ï¼Œä»¥åŠ DNS A è®°å½•ï¼ˆaliasï¼‰ã€‚å®‰å…¨ç»„è§„åˆ™é»˜è®¤å¼€æ”¾ HTTP/HTTPS æ‰€éœ€ç«¯å£ï¼›RouteÂ 53 DNS è®°å½•ä¼šå°† **lab.rendazhang.com** æ ¹åŸŸåè§£æåˆ°æ–°å»º ALB çš„åŸŸåä¸Šã€‚*è‹¥æ‚¨æœªé¢„å…ˆåˆ›å»º RouteÂ 53 Hosted Zoneï¼ŒTerraform åœ¨è¿™ä¸€æ­¥ä¼šæŠ¥é”™ï¼Œéœ€è¦åœ¨ AWS æ§åˆ¶å°æ‰‹åŠ¨åˆ›å»ºåä¸º `lab.rendazhang.com` çš„æ‰˜ç®¡åŒºæˆ–å°†åŸŸåå˜é‡è°ƒæ•´ä¸ºæ‚¨è‡ªå·±çš„å·²é…ç½®åŸŸåã€‚å¦‚ä¸éœ€è¦ DNSï¼Œå¯æš‚æ—¶å°†ç›¸å…³ Terraform èµ„æºæ³¨é‡Šæ‰ã€‚*

1. **æŸ¥è¯¢ ALB ä¿¡æ¯**ï¼šä½¿ç”¨ AWS CLI æˆ–æ§åˆ¶å°æŸ¥çœ‹ ALB æ˜¯å¦åˆ›å»ºæˆåŠŸï¼š

   ```bash
   aws elbv2 describe-load-balancers --names <ALB-NAME> --region us-east-1 --profile phase2-sso
   ```

   å…¶ä¸­ `<ALB-NAME>` å¯ä»¥é€šè¿‡ Terraform è¾“å‡ºæˆ– AWS æ§åˆ¶å°è·å¾—ï¼ˆä¸€èˆ¬ Terraform æ¨¡å—ä¼šä»¥ "lab-alb" å‘½å ALBï¼‰ã€‚ä»¥ä¸Šå‘½ä»¤åº”è¿”å› ALB çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ **DNSName**ï¼ˆALB çš„è®¿é—®åŸŸåï¼‰å’Œ **State: active** ç­‰å­—æ®µã€‚è®°å½•ä¸‹ ALB çš„ **DNSName** ä»¥å¤‡åç»­æµ‹è¯•ä½¿ç”¨ã€‚

1. **éªŒè¯ DNS è§£æ**ï¼šå¦‚æœé…ç½®äº† RouteÂ 53 åŸŸåï¼Œä½¿ç”¨ **nslookup** æˆ– **dig** æŸ¥è¯¢ `lab.rendazhang.com`ï¼š

   ```bash
   nslookup lab.rendazhang.com
   ```

   é¢„æœŸè§£æç»“æœçš„ CNAME æŒ‡å‘åˆšåˆ›å»ºçš„ ALB åŸŸåï¼Œä¾‹å¦‚ï¼š`dualstack.lab-alb-123456789.us-east-1.elb.amazonaws.com`ã€‚åœ¨æµè§ˆå™¨ä¸­è®¿é—® `http://lab.rendazhang.com` å½“å‰å¯èƒ½æ˜¾ç¤º 404 æˆ–é»˜è®¤å“åº”ï¼Œå› ä¸ºå°šæœªåœ¨ ALB ä¸Šéƒ¨ç½²åç«¯æœåŠ¡ï¼Œä½†èƒ½è¯æ˜åŸŸåè§£æå’Œ ALB Listener æ­£å¸¸å·¥ä½œã€‚

#### éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º

- **CLI éªŒè¯ ALBï¼š** æ‰§è¡Œ `aws elbv2 describe-load-balancers` è¿”å› JSON ä¸­ï¼Œåº”çœ‹åˆ°æ–°å»º ALB åˆ—è¡¨é¡¹ï¼Œå…¶ `"State": "active"` ä¸” `"DNSName"` å­—æ®µæœ‰ä¸€ä¸ª AWS æä¾›çš„ \*.elb.amazonaws.com åŸŸåã€‚ç¤ºä¾‹ï¼š

  ```json
  {
    "LoadBalancers": [{
      "LoadBalancerName": "lab-alb",
      "DNSName": "lab-alb-123456789.us-east-1.elb.amazonaws.com",
      "State": { "Code": "active" },
      "Type": "application",
      "Scheme": "internet-facing",
      ...
    }]
  }
  ```

- **DNS éªŒè¯ï¼š** æ‰§è¡Œ `nslookup`ï¼ˆæˆ– `dig`ï¼‰æŸ¥è¯¢è‡ªå®šä¹‰åŸŸåï¼Œè¾“å‡ºåº”åŒ…å«ç±»ä¼¼ä»¥ä¸‹è®°å½•ï¼š

  ```
  Name:    lab.rendazhang.com
  Address: 3.XX.YY.ZZ
  Name:    lab.rendazhang.com
  Address: 34.ZZ.YY.XX
  ```

  æˆ–æ˜¾ç¤º `lab.rendazhang.com	canonical name = lab-alb-123456789.us-east-1.elb.amazonaws.com.` è¡¨æ˜ DNS CNAME å·²æŒ‡å‘ ALBã€‚åœ¨æµè§ˆå™¨è®¿é—®è¯¥åŸŸåä¼šè¿”å› ALB é»˜è®¤å“åº”ï¼ˆå¦‚æœæœªæŒ‚è½½åç«¯ï¼Œåˆ™ä¸º 404ï¼‰ï¼Œè¡¨æ˜ ALB å¯¹å¤–å¯è¾¾ã€‚

#### å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰

- **Hosted Zone æœªæ‰¾åˆ°ï¼š** Terraform åˆ›å»º RouteÂ 53 è®°å½•æ—¶å¦‚æœæŠ¥é”™ *`NoSuchHostedZone`*ï¼Œè¯·ç¡®è®¤ **lab.rendazhang.com** Hosted Zone å·²åœ¨ RouteÂ 53 ä¸­åˆ›å»ºï¼Œæˆ–ä¿®æ”¹ Terraform ä¸­ `hosted_zone_id` å‚æ•°ä½¿ç”¨æ‚¨çš„å®é™… Hosted Zoneã€‚æ‚¨å¯ä»¥é€šè¿‡ AWS æ§åˆ¶å°çš„ RouteÂ 53 æœåŠ¡æ–°å»ºè¯¥åŸŸçš„æ‰˜ç®¡åŒºåŸŸï¼Œç„¶åé‡è·‘ Terraformã€‚
- **åŸŸåæœªè§£æï¼š** å¦‚æœ nslookup æ— æ³•è§£æåŸŸåï¼Œå¯èƒ½æ˜¯æœ¬åœ° DNS ç¼“å­˜æˆ–é…ç½®é—®é¢˜ï¼Œæˆ–åŸŸåæœªæ­£ç¡®æ‰˜ç®¡ã€‚å¯å°è¯•ç­‰å¾…å‡ åˆ†é’Ÿä»¥å…è®¸ DNS è®°å½•ç”Ÿæ•ˆï¼Œæˆ–ç”¨ `dig @8.8.8.8 lab.rendazhang.com` å¼ºåˆ¶ä½¿ç”¨å…¬å…± DNS æŸ¥è¯¢ã€‚
- **ALB é™é¢é—®é¢˜ï¼š** AWS å¸æˆ·é»˜è®¤ ALB æœ‰æ•°é‡ä¸Šé™ï¼Œå¦‚æœåˆ›å»º ALB æ—¶è¿”å›é…é¢è¶…é™é”™è¯¯ï¼Œå¯åˆ é™¤ä¸€äº›ä¸å¿…è¦çš„ ELB/ALB èµ„æºï¼Œæˆ–é€šè¿‡æäº¤ AWS Support æå‡ *Application Load Balancer Limit* é™é¢åé‡è¯•ã€‚
- **ALB çŠ¶æ€é activeï¼š** è‹¥ `describe-load-balancers` è¿”å› ALB çŠ¶æ€ä¸º *provisioning* æŒç»­ä¸å˜ï¼Œå¯èƒ½è¡¨ç¤ºæ­£åœ¨åˆ†é…å¼¹æ€§ IP æˆ–æœªæ‰¾åˆ°å¯ç”¨å­ç½‘ã€‚è¯·ç¡®ä¿æ‚¨çš„ VPC è‡³å°‘æœ‰ä¸¤ä¸ªå…¬æœ‰å­ç½‘ï¼Œæ¯ä¸ªå­ç½‘éƒ½æœ‰ Internet Gateway è·¯ç”±ï¼Œä¸” Terraform è„šæœ¬ä¸­çš„å­ç½‘ ID æ­£ç¡®æ— è¯¯ã€‚
- **å®‰å…¨ç»„æœªå¼€æ”¾ç«¯å£ï¼š** å¦‚æœåç»­æœåŠ¡æ— æ³•é€šè¿‡ ALB è®¿é—®ï¼Œæ£€æŸ¥ ALB å®‰å…¨ç»„è§„åˆ™æ˜¯å¦åŒ…å«å…è®¸çš„å…¥ç«™ç«¯å£ï¼ˆé»˜è®¤ä¸º 80/443ï¼‰ã€‚Terraform æ¨¡å—å·²ç»é¢„é…ç½®äº† HTTP/HTTPS è§„åˆ™ï¼Œå¦‚æœ‰è‡ªå®šä¹‰ç«¯å£éœ€æ±‚éœ€è¦æ‰‹åŠ¨æ·»åŠ å®‰å…¨ç»„è§„åˆ™ã€‚

#### âœ… é˜¶æ®µäºŒéªŒæ”¶æ¸…å•

- [ ] å·²åˆ›å»º ALBï¼ˆApplication Load Balancerï¼‰ï¼Œåœ¨ AWS æ§åˆ¶å°æˆ– CLI æŸ¥è¯¢ä¸­çŠ¶æ€ä¸º *active*ï¼Œç±»å‹ä¸º applicationï¼ŒScheme ä¸º internet-facingã€‚
- [ ] ALB åˆ†é…äº†**å®‰å…¨ç»„**ï¼Œå®‰å…¨ç»„å…¥ç«™è§„åˆ™åŒ…å« HTTP/HTTPS (80/443) ç­‰å¿…è¦ç«¯å£ï¼Œå‡ºç«™è§„åˆ™å¼€æ”¾è‡³ Internetã€‚
- [ ] **RouteÂ 53 DNS** è®°å½•å·²æˆåŠŸæ·»åŠ ï¼š`lab.rendazhang.com` CNAME æŒ‡å‘ ALB åŸŸåï¼ˆæˆ– A è®°å½•åˆ«åæŒ‡å‘ ALBï¼Œè§†é…ç½®è€Œå®šï¼‰ã€‚
- [ ] æœ¬åœ°é€šè¿‡åŸŸåæˆ– ALB å…¬å…± DNS æµ‹è¯•è¿æ¥ï¼ŒALB èƒ½è¿”å›é»˜è®¤å“åº”ï¼ˆ404/503 ç­‰ï¼Œå› æš‚æ— åç«¯ï¼Œä½†è¯æ˜è¿æ¥å·²åˆ°è¾¾ ALBï¼‰ã€‚
- [ ] Terraform çŠ¶æ€ä¸­å­˜åœ¨ ALB ç›¸å…³èµ„æºï¼ˆå¦‚ `aws_lb`ã€`aws_route53_record` ç­‰ï¼‰ï¼Œåç»­å¯é€šè¿‡ Terraform ç®¡ç†è¿™äº›èµ„æºçš„ç”Ÿå‘½å‘¨æœŸã€‚

---

## é˜¶æ®µä¸‰ï¼šIAM æƒé™é…ç½®

#### æ“ä½œç›®çš„ä¸èƒŒæ™¯

åœ¨åˆ›å»º EKS é›†ç¾¤ä¹‹å‰ï¼Œéœ€è¦å‡†å¤‡å¿…è¦çš„ **IAM è§’è‰²ä¸æƒé™**ã€‚EKS æ§åˆ¶å¹³é¢æœ¬èº«éœ€è¦ä¸€ä¸ªå…·æœ‰ç‰¹å®šæƒé™çš„æœåŠ¡è§’è‰²æ¥åˆ›å»ºå’Œç®¡ç†é›†ç¾¤ç›¸å…³çš„ AWS èµ„æºï¼ˆå¦‚å¼¹æ€§ç½‘å¡ã€å®‰å…¨ç»„ç­‰ï¼‰ï¼›æ­¤å¤–ï¼Œä¸ºå®ç°æ›´ç²¾ç»†çš„æƒé™æ§åˆ¶ï¼Œæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨ **IRSA (IAM Roles for Service Accounts)** ä¸º Kubernetes å†…çš„ç»„ä»¶ï¼ˆå¦‚ Cluster Autoscalerï¼‰èµ‹æƒã€‚å› æ­¤æœ¬é˜¶æ®µçš„ç›®æ ‡æ˜¯ï¼š

- åˆ›å»ºå¹¶é…ç½® EKS é›†ç¾¤çš„æœåŠ¡è§’è‰²ï¼ˆé€šå¸¸å‘½åä¸º **eks-admin-role**ï¼‰ï¼Œèµ‹äºˆ AWS æ‰˜ç®¡ç­–ç•¥ **AmazonEKSClusterPolicy** å’Œ **AmazonEKSVPCResourceController**, ä»¥æ»¡è¶³æ§åˆ¶å¹³é¢å¯¹åº•å±‚èµ„æºæ“ä½œçš„æƒé™è¦æ±‚ã€‚
- å‡†å¤‡ Cluster Autoscaler æ‰€éœ€çš„ IAM ç­–ç•¥å’Œè§’è‰²ã€‚Cluster Autoscaler éœ€è¦è°ƒç”¨ EC2 Auto Scaling APIï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€æ¡è‡ªå®šä¹‰ç­–ç•¥ï¼ˆç¤ºä¾‹å‘½å **EKSClusterAutoscalerPolicy**ï¼‰æˆäºˆæ‰€éœ€æƒé™ï¼Œå¹¶å…³è”åˆ°ä¸€ä¸ª IAM è§’è‰²ï¼ˆä¾‹å¦‚ **eks-cluster-autoscaler**ï¼‰ä¾› IRSA ä½¿ç”¨ã€‚

è¿™äº› IAM é…ç½®ä¿è¯ EKS é›†ç¾¤å’Œ Kubernetes å†…ç»„ä»¶éƒ½èƒ½éµå¾ªæœ€å°æƒé™åŸåˆ™å®‰å…¨è¿è¡Œã€‚

#### æ“ä½œæ­¥éª¤

1. **åˆ›å»º EKS é›†ç¾¤æœåŠ¡è§’è‰²ï¼ˆeks-admin-roleï¼‰ï¼š** æ‰“å¼€ AWS ç®¡ç†æ§åˆ¶å°ï¼Œå¯¼èˆªåˆ° **IAM æœåŠ¡ -> è§’è‰² (Roles)**ï¼Œç‚¹å‡»â€œåˆ›å»ºè§’è‰² (Create role)â€ï¼š

   - **å—ä¿¡å®ä½“ç±»å‹ï¼š** é€‰æ‹© â€œAWS æœåŠ¡â€ï¼Œç„¶åé€‰æ‹© **EKS**ï¼Œåœ¨ç”¨é€”ä¸­é€‰æ‹© **EKS - Cluster**ï¼ˆEKS é›†ç¾¤ï¼‰ä½œä¸ºä¿¡ä»»å®ä½“ã€‚è¿™å°†è‡ªåŠ¨æ·»åŠ  EKS åˆ›å»ºé›†ç¾¤æ‰€éœ€çš„ä¿¡ä»»ç­–ç•¥ã€‚
   - **é™„åŠ æƒé™ç­–ç•¥ï¼š** åœ¨ç­–ç•¥åˆ—è¡¨ä¸­æœç´¢å¹¶å‹¾é€‰ **AmazonEKSClusterPolicy** å’Œ **AmazonEKSVPCResourceController** ä¸¤é¡¹æ‰˜ç®¡ç­–ç•¥ã€‚è¿™ä¸¤é¡¹ç­–ç•¥åˆ†åˆ«å…è®¸ EKS ç®¡ç†é›†ç¾¤å’Œç®¡ç† VPC èµ„æºçš„å¿…è¦æ“ä½œã€‚
   - **è®¾ç½®è§’è‰²åç§°ï¼š** å°†è§’è‰²å‘½åä¸º **eks-admin-role**ï¼ˆæˆ–æ ¹æ®çº¦å®šå‘½åï¼‰ã€‚å®Œæˆåˆ›å»ºã€‚

   åˆ›å»ºå®Œæˆåï¼Œè¿›å…¥è¯¥è§’è‰²è¯¦æƒ…é¡µï¼Œå¤åˆ¶å…¶ **ARN**ï¼ˆç±»ä¼¼ `arn:aws:iam::<AccountID>:role/eks-admin-role`ï¼‰ã€‚ç¨åå°†åœ¨ eksctl é›†ç¾¤é…ç½®æ–‡ä»¶å’Œ Terraform ä¸­å¼•ç”¨æ­¤ ARNã€‚

1. **ä¸º IRSA å‡†å¤‡ IAM ç­–ç•¥ï¼ˆCluster Autoscaler Policyï¼‰ï¼š** åœ¨ IAM æ§åˆ¶å°ï¼Œå¯¼èˆªåˆ° **ç­–ç•¥ (Policies)** å¹¶ç‚¹å‡»â€œåˆ›å»ºç­–ç•¥â€ã€‚é€‰æ‹© **JSON** é€‰é¡¹å¡ï¼Œå°†ä¸‹é¢çš„ç­–ç•¥å†…å®¹ç²˜è´´è¿›å»ï¼ˆè¯¥ç­–ç•¥æºè‡ªå®˜æ–¹æ¨èçš„ Cluster Autoscaler æƒé™ï¼‰ï¼š

   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "autoscaling:SetDesiredCapacity",
           "autoscaling:TerminateInstanceInAutoScalingGroup",
           "autoscaling:UpdateAutoScalingGroup",
           "autoscaling:DescribeAutoScalingGroups",
           "autoscaling:DescribeAutoScalingInstances",
           "autoscaling:DescribeLaunchConfigurations",
           "autoscaling:DescribeTags",
           "ec2:DescribeInstanceTypes",
           "ec2:DescribeLaunchTemplateVersions"
         ],
         "Resource": "*"
       }
     ]
   }
   ```

   ä»¥ä¸Šç­–ç•¥æˆäºˆ Cluster Autoscaler è°ƒæ•´ ASG å’ŒæŸ¥è¯¢èµ„æºçš„æƒé™ã€‚ç‚¹å‡»â€œä¸‹ä¸€æ­¥â€ï¼Œä¸ºç­–ç•¥å‘½åä¸º **EKSClusterAutoscalerPolicy**ï¼Œå¹¶å®Œæˆåˆ›å»ºã€‚

1. **åˆ›å»º Cluster Autoscaler IRSA è§’è‰²ï¼ˆeks-cluster-autoscalerï¼‰ï¼š** è¿”å› **IAM -> è§’è‰²**ï¼Œç‚¹å‡»â€œåˆ›å»ºè§’è‰²â€ï¼š

   - **å—ä¿¡å®ä½“ç±»å‹ï¼š** é€‰æ‹© **Web Identity**ï¼ˆWeb èº«ä»½æä¾›è€…ï¼‰ã€‚åœ¨ä¸‹æ‹‰ä¸­é€‰æ‹©åˆšåˆ›å»ºçš„ EKS é›†ç¾¤çš„ **OIDC æä¾›è€…**ï¼Œä¸»ä½“ä¸º `sts.amazonaws.com`ã€‚åœ¨å…·ä½“èº«ä»½æä¾›è€…é€‰é¡¹ä¸­ï¼Œé€‰æ‹©æ‚¨çš„é›†ç¾¤ OIDC URLï¼ˆ eksctl åˆ›å»ºé›†ç¾¤æ—¶å¼€å¯äº† OIDC æ”¯æŒï¼‰ã€‚
   - **æ·»åŠ ä¿¡ä»»æ¡ä»¶ï¼š** å½“é€‰æ‹© OIDC æä¾›è€…åï¼Œéœ€è¦æŒ‡å®šå¯æ‰®æ¼”æ­¤è§’è‰²çš„ Kubernetes æœåŠ¡è´¦å·ã€‚è®¾ç½® **æ¡ä»¶ (Condition)** ä¸­çš„ `sub` å€¼ä¸ºï¼š`system:serviceaccount:kube-system:cluster-autoscaler`ã€‚è¿™è¡¨ç¤ºä»… `kube-system` å‘½åç©ºé—´ä¸­åä¸º `cluster-autoscaler` çš„æœåŠ¡è´¦å·å¯ä»¥é€šè¿‡ IRSA æ¥è·å–æ­¤è§’è‰²ã€‚
   - **é™„åŠ æƒé™ç­–ç•¥ï¼š** é€‰ä¸­ä¸Šä¸€æ­¥åˆ›å»ºçš„ **EKSClusterAutoscalerPolicy**ï¼ˆæˆ–å¦‚æœæ‚¨å¸Œæœ›ï¼Œä¹Ÿå¯ç›´æ¥é™„åŠ  Amazon ç®¡ç†çš„ AutoScalingFullAccessï¼Œä½†è‡ªå®šä¹‰ç­–ç•¥æƒé™æ›´ç²¾ç»†ï¼‰ã€‚
   - **è§’è‰²å‘½åï¼š** å‘½åä¸º **eks-cluster-autoscaler**ï¼Œå®Œæˆåˆ›å»ºã€‚

   åˆ›å»ºå®Œæˆåï¼Œè®°å½•ä¸‹è¯¥è§’è‰²çš„ ARNã€‚å¦‚æœªå¼€å¯ OIDC æä¾›è€…æˆ–é…ç½®é”™è¯¯ï¼Œæ§åˆ¶å°å°†æ— æ³•åˆ—å‡º EKS é›†ç¾¤ OIDCï¼Œéœ€è¦æ‚¨å…ˆé€šè¿‡ `eksctl utils associate-iam-oidc-provider` æˆ– Terraform åˆ›å»º OIDC æä¾›å•†ã€‚é€šå¸¸ä½¿ç”¨ eksctl ä¸” YAML ä¸­ `iam.withOIDC: true` å·²è‡ªåŠ¨å®Œæˆæ­¤æ­¥éª¤ã€‚

1. **é…ç½® Terraform å˜é‡ï¼š** æ‰“å¼€ `infra/aws/terraform.tfvars` æ–‡ä»¶ï¼Œç¡®è®¤å…¶ä¸­ `eks_admin_role_arn` å·²è®¾ç½®ä¸ºåˆšæ‰åˆ›å»ºçš„ eks-admin-role çš„ ARNã€‚é»˜è®¤è¯¥æ–‡ä»¶å·²å¡«å†™ä¸€ä¸ªç¤ºä¾‹ ARNï¼Œè¯·ç¡®ä¿æ›¿æ¢ä¸ºæ‚¨è´¦æˆ·ä¸­è§’è‰²çš„å®é™… ARNã€‚å¦‚æœä¹‹å‰æœªåˆ›å»º eks-admin-role æˆ– ARN æœ‰è¯¯ï¼Œè¿™é‡Œéœ€è¦æ›´æ–°åå†ç»§ç»­ã€‚

   > **æ³¨æ„ï¼š** Terraform è„šæœ¬å·²åŒ…å«åˆ›å»º IRSA è§’è‰²çš„æ¨¡å—ï¼Œä¼šä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ OIDC Provider å’Œå›ºå®šçš„æœåŠ¡è´¦å·åç§°æ¥å®šä¹‰ IRSA è§’è‰²å’Œç­–ç•¥é™„åŠ ã€‚ç”±äºè„šæœ¬ä¸­ **ç¡¬ç¼–ç ** äº† Autoscaler ç­–ç•¥ ARNï¼ˆé»˜è®¤æŒ‡å‘è´¦æˆ· 563149051155 çš„ EKSClusterAutoscalerPolicyï¼‰, è¯·åŠ¡å¿…ä¿®æ”¹ Terraform è„šæœ¬æˆ–å˜é‡ä»¥ä½¿ç”¨æ‚¨è‡ªå·±è´¦æˆ·ä¸­çš„ç­–ç•¥ ARNï¼Œå¦åˆ™åç»­å¯¼å…¥/åº”ç”¨è¿‡ç¨‹å¯èƒ½å¤±è´¥ã€‚

   > **ğŸ’¡ ä¿®å¤å»ºè®®ï¼š** æœ€ä½³å®è·µæ˜¯åœ¨ Terraform è„šæœ¬ä¸­å°†ç­–ç•¥ ARN æå–ä¸ºå¯é…ç½®å˜é‡ï¼Œè€Œä¸æ˜¯å†™æ­»å…·ä½“ ARNã€‚å¦‚æœæ‚¨æ‹¥æœ‰è¯¥ä»£ç åº“çš„ç»´æŠ¤æƒé™ï¼Œå¯å°† IRSA æ¨¡å—çš„ `aws_iam_role_policy_attachment` ä¸­çš„ `policy_arn` æ”¹ä¸ºä¸€ä¸ªå˜é‡ï¼ˆä¾‹å¦‚ `var.autoscaler_policy_arn`ï¼‰ï¼Œå¹¶é€šè¿‡ tfvars æä¾›ï¼Œä»¥æé«˜ä»£ç çš„å¯ç§»æ¤æ€§ã€‚

#### éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º

- ç™»å½• AWS æ§åˆ¶å°ï¼Œæ£€æŸ¥ **IAM -> è§’è‰²** åˆ—è¡¨ï¼Œåº”å‡ºç° **eks-admin-role** å’Œ **eks-cluster-autoscaler** ä¸¤ä¸ªæ–°è§’è‰²ã€‚ç‚¹è¿› eks-admin-role çš„ **æƒé™** æ ‡ç­¾é¡µï¼Œç¡®è®¤å·²é™„åŠ  **AmazonEKSClusterPolicy** å’Œ **AmazonEKSVPCResourceController** ä¸¤é¡¹ç­–ç•¥ã€‚

- æŸ¥çœ‹ eks-cluster-autoscaler è§’è‰²çš„ **ä¿¡ä»»å…³ç³»** é…ç½®ï¼Œåº”åŒ…å« Web Identity ä¿¡ä»»ï¼ŒIssuer ä¸ºæ‚¨çš„ EKS é›†ç¾¤ OIDC æä¾›è€…ï¼ŒCondition åŒ…å« `sub: system:serviceaccount:kube-system:cluster-autoscaler`ã€‚

- eks-cluster-autoscaler è§’è‰²çš„ **æƒé™** æ ‡ç­¾é¡µåº”é™„åŠ äº† **EKSClusterAutoscalerPolicy** ç­–ç•¥ï¼Œç‚¹è¿›è¯¥ç­–ç•¥å¯æ ¸å¯¹ä¹‹å‰å®šä¹‰çš„ JSON å†…å®¹æ˜¯å¦æ­£ç¡®ç”Ÿæ•ˆã€‚

- ï¼ˆå¯é€‰ CLI éªŒè¯ï¼‰ä½¿ç”¨ AWS CLI è·å–ä¸Šè¿°è§’è‰²ä¿¡æ¯ï¼š

  ```bash
  aws iam list-attached-role-policies --role-name eks-admin-role --profile phase2-sso
  aws iam get-role --role-name eks-cluster-autoscaler --profile phase2-sso
  ```

  å‰è€…åº”åˆ—å‡ºåŒ…å« `AmazonEKSClusterPolicy` ç­‰ç­–ç•¥çš„ ARNï¼›åè€…è¿”å›è§’è‰²ä¿¡ä»»å…³ç³» JSONï¼Œå…¶ä¸­ `AssumeRolePolicyDocument` å­—æ®µåŒ…å«æˆ‘ä»¬è®¾ç½®çš„ OIDC æ¡ä»¶ã€‚

#### å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰

- **è§’è‰²åˆ›å»ºå¤±è´¥æˆ–æ— æƒé™é€‰é¡¹ï¼š** ç¡®è®¤æ‚¨åœ¨åˆ›å»º eks-admin-role æ—¶é€‰æ‹©çš„æ˜¯ **EKS - Cluster** ç”¨é€”ã€‚å¦‚æœæœªæ­£ç¡®é€‰æ‹©ï¼Œå¯èƒ½å¯¼è‡´ç¼ºå°‘é»˜è®¤ä¿¡ä»»å…³ç³»ã€‚æ‚¨å¯ä»¥åœ¨è§’è‰²åˆ›å»ºåæ‰‹åŠ¨ç¼–è¾‘ä¿¡ä»»å…³ç³»ç­–ç•¥ä¸ºï¼š

  ```json
  {
    "Version": "2012-10-17",
    "Statement": [{
      "Effect": "Allow",
      "Principal": { "Service": "eks.amazonaws.com" },
      "Action": "sts:AssumeRole"
    }]
  }
  ```

  å¹¶é‡æ–°é™„åŠ æ‰€éœ€ç­–ç•¥ã€‚æˆ–è€…åˆ é™¤è§’è‰²é‡æ–°æŒ‰æ­¥éª¤åˆ›å»ºã€‚

- **OIDC æä¾›å•†æœªé…ç½®ï¼š** å¦‚æœåœ¨åˆ›å»º IRSA è§’è‰²æ—¶ï¼Œçœ‹ä¸åˆ°é¢„æœŸçš„ OIDC Providerï¼Œå¯èƒ½æ˜¯ eksctl åˆ›å»ºé›†ç¾¤æ­¥éª¤æ¼æ‰äº† `withOIDC: true`ã€‚è§£å†³æ–¹æ³•ï¼šåœ¨ EKS é›†ç¾¤åˆ›å»ºå®Œæˆåï¼Œæ‰§è¡Œå‘½ä»¤ `eksctl utils associate-iam-oidc-provider --cluster dev --approve --profile phase2-sso` å°† OIDC æä¾›å•†å…³è”åˆ°é›†ç¾¤ã€‚ç„¶åé‡æ–°åˆ›å»º IRSA è§’è‰²å¹¶é™„åŠ ç­–ç•¥ã€‚

- **ç­–ç•¥ ARN é…ç½®é”™è¯¯ï¼š** å‡å¦‚ Terraform åç»­ import è„šæœ¬åœ¨é™„åŠ ç­–ç•¥æ—¶æŠ¥é”™ *NoSuchEntity*ï¼Œå¯èƒ½æ˜¯ IRSA æ¨¡å—ç¡¬ç¼–ç çš„ç­–ç•¥ ARN æœªæŒ‡å‘æ­£ç¡®çš„ç­–ç•¥ã€‚è¯·ç¡®ä¿æ‚¨åœ¨ Terraform è„šæœ¬ä¸­æ›´æ–°äº†ç­–ç•¥ ARNï¼ˆæˆ–åœ¨ tf-import æ—¶ä¿®æ”¹è„šæœ¬çš„ `POLICY_ARN` å˜é‡ä¸ºæ‚¨çš„ç­–ç•¥ ARNï¼‰ã€‚

- **æƒé™ä¸è¶³ï¼š** åç»­å¦‚æœå‘ç° EKS é›†ç¾¤åˆ›å»ºå¤±è´¥ï¼Œé”™è¯¯æŒ‡å‘ IAM è§’è‰²é—®é¢˜ï¼Œæ£€æŸ¥ eks-admin-role æ˜¯å¦ç¡®å®å…·å¤‡äº†ä¸Šè¿°ä¸¤ä¸ªç­–ç•¥ï¼Œç‰¹åˆ«æ˜¯ AmazonEKSVPCResourceController å¯¹åº” VPC å­ç½‘å’Œå®‰å…¨ç»„çš„ç®¡ç†æƒé™ã€‚å¿…è¦æ—¶é™„åŠ  **AmazonEKSServicePolicy**ï¼ˆEKS æœåŠ¡ç­–ç•¥ï¼‰ä»¥æ»¡è¶³æ›´å¤šé›†ç¾¤æ“ä½œéœ€è¦ã€‚

- **Profile å‡­è¯é—®é¢˜ï¼š** å¦‚æœä½¿ç”¨ CLI åˆ›å»º/æŸ¥è¯¢è§’è‰²é‡åˆ°æƒé™é”™è¯¯ï¼Œç¡®è®¤å·²ä½¿ç”¨æ­£ç¡®çš„ `phase2-sso` Profile ç™»å½•ä¸”è¯¥è´¦æˆ·æœ‰è¶³å¤Ÿæƒé™åˆ›å»ºå’ŒæŸ¥çœ‹ IAM è§’è‰²ã€‚

#### âœ… é˜¶æ®µä¸‰éªŒæ”¶æ¸…å•

- [ ] **eks-admin-role** è§’è‰²å·²åˆ›å»ºï¼Œå¹¶é™„åŠ  **AmazonEKSClusterPolicy** å’Œ **AmazonEKSVPCResourceController** ç­–ç•¥ã€‚ä¿¡ä»»å®ä½“åŒ…å« `eks.amazonaws.com` æœåŠ¡ã€‚
- [ ] **EKSClusterAutoscalerPolicy** è‡ªå®šä¹‰ç­–ç•¥å·²åˆ›å»ºï¼Œç­–ç•¥å†…å®¹åŒ…å« Cluster Autoscaler æ‰€éœ€çš„ Auto Scaling å’Œ EC2 æƒé™ï¼ˆSetDesiredCapacityã€TerminateInstance ç­‰ï¼‰ã€‚
- [ ] **eks-cluster-autoscaler** è§’è‰²å·²åˆ›å»ºï¼Œä¸”ä¿¡ä»»å…³ç³»æŒ‡å®šäº†é›†ç¾¤çš„ OIDC æä¾›è€…ä»¥åŠ `system:serviceaccount:kube-system:cluster-autoscaler` æ¡ä»¶é™å®šã€‚
- [ ] eks-cluster-autoscaler è§’è‰²å·²é™„åŠ  **EKSClusterAutoscalerPolicy** ç­–ç•¥ã€‚åç»­ Kubernetes é›†ç¾¤ä¸­çš„ `cluster-autoscaler` æœåŠ¡è´¦å·å°†å¯é€šè¿‡ IRSA è·å¾—è¯¥è§’è‰²æƒé™ã€‚
- [ ] Terraform é…ç½®æ–‡ä»¶ä¸­çš„ `eks_admin_role_arn` å·²æ›´æ–°ä¸º eks-admin-role çš„å®é™… ARNï¼ŒIRSA æ¨¡å—ä¸­ Cluster Autoscaler ç­–ç•¥ ARN å·²è°ƒæ•´ä¸ºæ‚¨çš„ç­–ç•¥ ARNï¼ˆæˆ–å·²è®°å½•ä¿®æ”¹è®¡åˆ’ï¼‰ã€‚

---

## é˜¶æ®µå››ï¼šEKS é›†ç¾¤éƒ¨ç½²

#### æ“ä½œç›®çš„ä¸èƒŒæ™¯

å®Œæˆç½‘ç»œå’Œ IAM å‡†å¤‡åï¼Œç°åœ¨è¿›å…¥æ ¸å¿ƒçš„ **Amazon EKS é›†ç¾¤** éƒ¨ç½²é˜¶æ®µã€‚æœ¬é˜¶æ®µå°†ä½¿ç”¨ **eksctl** æ ¹æ®é¢„å®šä¹‰çš„ YAML é…ç½®æ–‡ä»¶åˆ›å»º Kubernetes æ§åˆ¶å¹³é¢å’ŒèŠ‚ç‚¹ç»„ã€‚é€šè¿‡ eksctlï¼Œé›†ç¾¤èƒ½å¤Ÿå¿«é€Ÿåœ°åœ¨æ—¢æœ‰ VPC ä¸­æ­å»ºï¼ŒèŠ‚ç‚¹ç»„å¯ä»¥å¯ç”¨ Spot å®ä¾‹ä»¥é™ä½æˆæœ¬ï¼Œå¹¶è‡ªåŠ¨é…ç½®å¿…è¦çš„èŠ‚ç‚¹ IAM è§’è‰²ã€å®‰å…¨ç»„ç­‰ã€‚æˆ‘ä»¬é€‰æ‹© eksctl è€Œé Terraform åˆ›å»ºé›†ç¾¤ï¼Œä¸»è¦æ˜¯åˆ©ç”¨å…¶ç®€æ´çš„å£°æ˜å¼é…ç½®å’Œä¸€é”®å¼éƒ¨ç½²èƒ½åŠ›ã€‚åŒæ—¶ï¼Œåœ¨é›†ç¾¤åˆ›å»ºå®Œæˆåï¼Œæˆ‘ä»¬å°†é€šè¿‡å¯¼å…¥ï¼ˆä¸‹ä¸€é˜¶æ®µï¼‰å°†é›†ç¾¤çº³å…¥ Terraform ç®¡ç†ï¼Œä»¥ä¿æŒåŸºç¡€è®¾æ–½ä¸€è‡´æ€§ã€‚æœ¬é˜¶æ®µç»“æŸåï¼Œåº”å½“æœ‰ä¸€ä¸ªçŠ¶æ€ä¸º **Active** çš„ EKS é›†ç¾¤å’Œè¿è¡Œä¸­çš„å·¥ä½œèŠ‚ç‚¹ã€‚

#### æ“ä½œæ­¥éª¤

1. **æŸ¥çœ‹ eksctl é…ç½®æ–‡ä»¶**ï¼šæ‰“å¼€é¡¹ç›®ä¸­çš„ `infra/eksctl/eksctl-cluster.yaml` æ–‡ä»¶ï¼Œäº†è§£é›†ç¾¤é…ç½®å†…å®¹ã€‚å…³é”®é…ç½®åŒ…æ‹¬ï¼š

   - é›†ç¾¤åç§° **dev**ï¼ŒåŒºåŸŸ **us-east-1**ã€‚
   - VPC ç½‘ç»œï¼šå¼•ç”¨äº†ç°æœ‰ VPC ID å’Œå­ç½‘ IDï¼ˆæ¥è‡ª Terraform åˆ›å»ºçš„ VPCï¼‰ã€‚è¯·ç¡®ä¿è¿™äº› ID ä¸æ‚¨ç¬¬ä¸€é˜¶æ®µåˆ›å»ºçš„ VPC/å­ç½‘ä¸€è‡´ã€‚å¦‚æœ‰ä¸åŒï¼Œéœ€ä¿®æ”¹ YAML ä½¿ä¹‹åŒ¹é…æ­£ç¡®çš„èµ„æºã€‚
   - IAM é›†æˆï¼š`withOIDC: true` å¼€å¯äº† OIDC æä¾›å•†ç”¨äº IRSAï¼›`serviceRoleARN` è®¾ç½®ä¸ºæˆ‘ä»¬åœ¨ä¸Šä¸€é˜¶æ®µåˆ›å»ºçš„ eks-admin-role çš„ ARNï¼Œç¡®ä¿æ§åˆ¶å¹³é¢ä½¿ç”¨é¢„æˆæƒè§’è‰²ã€‚
   - èŠ‚ç‚¹ç»„é…ç½®ï¼šå®šä¹‰äº†ä¸€ä¸ªåä¸º **ng-mixed** çš„æ‰˜ç®¡èŠ‚ç‚¹ç»„ï¼Œæœ€å° 0ã€æœŸæœ› 3ã€æœ€å¤§ 6 èŠ‚ç‚¹ï¼Œä½¿ç”¨ Spot å®ä¾‹ï¼ˆç±»å‹åŒ…æ‹¬ t3.small å’Œ t3.mediumï¼‰ã€‚Spot å®ä¾‹ä¸ä¿è¯éšæ—¶æœ‰å®¹é‡ï¼Œå¯ç”¨åå¯å¤§å¹…èŠ‚çœæˆæœ¬ï¼Œä¸”èŠ‚ç‚¹ç»„æ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹ã€‚
   - èŠ‚ç‚¹ç»„ä½¿ç”¨**ç§æœ‰å­ç½‘**éƒ¨ç½²ï¼ˆprivateNetworking: trueï¼‰ï¼Œæ„å‘³ç€å·¥ä½œèŠ‚ç‚¹ä¸æš´éœ²å…¬æœ‰ IPã€‚æ‰€æœ‰æµé‡ç»ç”± NAT å‡ºç½‘ã€‚
   - èŠ‚ç‚¹æ ‡ç­¾å’Œæ±¡ç‚¹ï¼šæ­¤ä¾‹æœªè®¾ç½®æ±¡ç‚¹ï¼Œæ ‡ç­¾æ ‡è®° role=worker ç­‰ï¼Œç”¨äºæ ‡è¯†èŠ‚ç‚¹ç”¨é€”ã€‚
   - å‡çº§ç­–ç•¥ç­‰å…¶ä»–ç»†èŠ‚ã€‚é€šå¸¸æ— éœ€æ”¹åŠ¨ä¸Šè¿°é»˜è®¤é…ç½®ï¼Œä½†è¯·æ ¸å® eks-admin-role ARNã€Subnet IDs æ˜¯å¦å‡†ç¡®ï¼Œå¦åˆ™åˆ›å»ºä¼šå¤±è´¥ã€‚

1. **æ‰§è¡Œé›†ç¾¤åˆ›å»º**ï¼šç¡®ä¿ AWS SSO å·²ç™»å½•ï¼Œç„¶åè¿è¡Œ eksctl åˆ›å»ºé›†ç¾¤å‘½ä»¤ï¼š

   ```bash
   eksctl create cluster -f infra/eksctl/eksctl-cluster.yaml --profile phase2-sso
   ```

   eksctl å°†æ ¹æ® YAML é…ç½®å¼€å§‹åˆ›å»º EKS æ§åˆ¶å¹³é¢å’ŒèŠ‚ç‚¹ç»„ã€‚è¿™ä¸€æ­¥è€—æ—¶çº¦ 10~15 åˆ†é’Ÿã€‚æ—¥å¿—ä¸­å°†æ˜¾ç¤ºæ­£åœ¨åˆ›å»ºçš„èµ„æºï¼Œå¦‚ VPC å­ç½‘é…ç½®ã€å®‰å…¨ç»„ã€EC2 å®ä¾‹ç­‰ã€‚è€å¿ƒç­‰å¾…ç›´åˆ° eksctl è¾“å‡º **EKS cluster "dev" in "us-east-1" is ready** æˆ–ç±»ä¼¼æˆåŠŸæ¶ˆæ¯ã€‚

   > **æ³¨æ„ï¼š** å¦‚æœæ‚¨ä¹‹å‰å·²å­˜åœ¨åä¸º dev çš„é›†ç¾¤ï¼Œè¯·å…ˆåˆ é™¤æˆ–æ›´æ¢åç§°ã€‚å¦åˆ™ eksctl ä¼šè­¦å‘Šé›†ç¾¤å·²å­˜åœ¨è€Œç»ˆæ­¢æ“ä½œã€‚åˆ é™¤é›†ç¾¤å¯å‚è€ƒé˜¶æ®µä¸ƒçš„åšæ³•ä½¿ç”¨ `eksctl delete cluster --name dev`ã€‚

1. **æ›´æ–° kubeconfigï¼š** eksctl åˆ›å»ºé›†ç¾¤æˆåŠŸåï¼Œé€šå¸¸ä¼šè‡ªåŠ¨å°†æ–°é›†ç¾¤çš„è®¤è¯ä¿¡æ¯åŠ å…¥æœ¬åœ° kubeconfig æ–‡ä»¶ï¼ˆé€šå¸¸ä½äº `~/.kube/config`ï¼‰ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç¡®ä¿å½“å‰ä¸Šä¸‹æ–‡æŒ‡å‘æ–°é›†ç¾¤ï¼š

   ```bash
   aws eks update-kubeconfig --name dev --region us-east-1 --profile phase2-sso
   ```

   è¯¥å‘½ä»¤å°†ä½¿ç”¨ AWS CLI å°† EKS é›†ç¾¤çš„è®¿é—®å‡­è¯æ·»åŠ åˆ° kubeconfigã€‚å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œè¡¨ç¤º kubeconfig æ›´æ–°å®Œæ¯•ã€‚

1. **éªŒè¯é›†ç¾¤è¿è¡ŒçŠ¶æ€**ï¼šä½¿ç”¨ kubectl éªŒè¯ EKS é›†ç¾¤çš„åŸºæœ¬è¿è¡Œæƒ…å†µï¼š

   ```bash
   kubectl get nodes
   kubectl get pods -A
   ```

   é¢„æœŸ `get nodes` åˆ—å‡ºæ–°é›†ç¾¤çš„èŠ‚ç‚¹ï¼ˆåº”æœ‰ 3 ä¸ª Ready çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œå¯¹äº Spot ç±»å‹å¦‚æœéƒ¨åˆ†æš‚ä¸å¯ç”¨èŠ‚ç‚¹æ•°å¯èƒ½å°‘äºæœŸæœ›å€¼ï¼‰ã€‚`get pods -A` ä¼šåˆ—å‡º `kube-system` ç­‰å‘½åç©ºé—´ä¸­çš„ç³»ç»Ÿ Podï¼Œå…¶ä¸­æ ¸å¿ƒ DNSã€CNI æ’ä»¶ç­‰ Pod åº”ä¸º Running çŠ¶æ€ã€‚å¦‚æœæ‰€æœ‰èŠ‚ç‚¹å’Œç³»ç»Ÿ Pod æ­£å¸¸ï¼Œåˆ™é›†ç¾¤å·²æˆåŠŸå¯åŠ¨ã€‚

#### éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º

- **eksctl è¾“å‡ºç¡®è®¤ï¼š** åœ¨ eksctl æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ—¥å¿—æœ€åé€šå¸¸æœ‰ **"EKS cluster <dev> in <us-east-1> is ready"**ï¼Œå¹¶åˆ—å‡ºèŠ‚ç‚¹ç»„çš„èŠ‚ç‚¹ä¿¡æ¯å¦‚ EC2 å®ä¾‹ IDã€‚æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ AWS æ§åˆ¶å°çš„ EKS é¡µé¢æŸ¥çœ‹ **dev** é›†ç¾¤çŠ¶æ€ä¸º **Active**ã€‚

- **AWS æ§åˆ¶å°æ£€æŸ¥ï¼š** æ‰“å¼€ Amazon EKS æ§åˆ¶å°ï¼Œå®šä½åˆ° us-east-1 åŒºåŸŸï¼Œçœ‹åˆ°åä¸º dev çš„é›†ç¾¤ï¼Œç‚¹å…¥å¯ä»¥æŸ¥çœ‹å…¶ **èŠ‚ç‚¹ç»„** åˆ—è¡¨æœ‰ä¸€ä¸ª ng-mixedï¼ŒæœŸæœ›å®¹é‡ 3ï¼Œå½“å‰è¿è¡ŒèŠ‚ç‚¹æ•°å¯èƒ½ä¸º 2-3ï¼ˆSpot å®¹é‡æƒ…å†µï¼‰ã€‚åœ¨ **è®¡ç®— -> EC2 å®ä¾‹** é¡µé¢ï¼Œå¯ä»¥æ‰¾åˆ°å±äºè¯¥èŠ‚ç‚¹ç»„çš„ EC2 å®ä¾‹ï¼ˆName é€šå¸¸å«æœ‰ dev å’Œ ng-mixed å­—æ ·ï¼‰ï¼ŒçŠ¶æ€ä¸º runningã€‚

- **kubectl è¾“å‡ºï¼š** æ‰§è¡Œ `kubectl get nodes`ï¼Œç¤ºä¾‹è¾“å‡ºï¼š

  ```
  NAME                                           STATUS   ROLES    AGE   VERSION
  ip-192-168-xx-xx.us-east-1.compute.internal    Ready    <none>   5m    v1.30...
  ip-192-168-yy-yy.us-east-1.compute.internal    Ready    <none>   5m    v1.30...
  ip-192-168-zz-zz.us-east-1.compute.internal    Ready    <none>   5m    v1.30...
  ```

  ä»¥ä¸Šè¡¨ç¤º 3 ä¸ªèŠ‚ç‚¹å‡å·²å°±ç»ª (STATUS = Ready)ã€‚
  `kubectl get pods -A` åˆ—å‡ºå„å‘½åç©ºé—´ Podï¼Œå…¶ä¸­ `kube-system` ä¸‹çš„ **coredns**ã€**aws-node**ï¼ˆVPC CNI æ’ä»¶ï¼‰ã€**kube-proxy** ç­‰ Pod å‡åº”ä¸º **Running** æˆ– **Completed** çŠ¶æ€ï¼Œæ²¡æœ‰æŒç»­ CrashLoop çš„ç°è±¡ã€‚

#### å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰

- **eksctl å‘½ä»¤æœªæ‰¾åˆ°æˆ–ç‰ˆæœ¬è¿‡ä½ï¼š** å¦‚æœç»ˆç«¯æç¤º *`eksctl: command not found`*ï¼Œè¯·å…ˆç¡®è®¤å·²å®‰è£… eksctl å·¥å…·å¹¶é…ç½®åœ¨ PATH ä¸­ã€‚ç‰ˆæœ¬è¿‡ä½å¯èƒ½å¯¼è‡´ä¸æ”¯æŒæœ€æ–° EKS ç‰¹æ€§ï¼Œå»ºè®®ä½¿ç”¨æ–‡æ¡£è¦æ±‚çš„ç‰ˆæœ¬ï¼ˆâ‰¥0.180ï¼‰ã€‚å‡çº§ eksctl å¯é€šè¿‡ `brew upgrade eksctl` (Mac) æˆ–ä» GitHub releases æ‰‹åŠ¨ä¸‹è½½ã€‚
- **IAM è§’è‰²é”™è¯¯å¯¼è‡´åˆ›å»ºå¤±è´¥ï¼š** å¦‚æœ eksctl æ—¥å¿—æ˜¾ç¤ºé”™è¯¯ä¾‹å¦‚ *`cannot assume role arn:aws:iam::...:role/eks-admin-role`* æˆ– *`AccessDenied`*ï¼Œè¯·æ£€æŸ¥ YAML ä¸­ `serviceRoleARN` æ˜¯å¦æ­£ç¡®å¡«å…¥äº† eks-admin-role çš„ ARN ä¸”è¯¥è§’è‰²å·²é™„åŠ å¿…è¦ç­–ç•¥ï¼ˆé˜¶æ®µä¸‰æ£€æŸ¥ï¼‰ã€‚ä¿®æ­£ ARN æˆ–æƒé™åï¼Œå¯ä½¿ç”¨ `eksctl delete cluster --name dev` æ¸…ç†å¤±è´¥çš„æ®‹ä½™ï¼Œç„¶åé‡æ–°æ‰§è¡Œåˆ›å»ºã€‚
- **Subnet ID æ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼š** è‹¥ eksctl æŠ¥ *`InvalidSubnetID.NotFound`*ï¼Œè¯´æ˜ YAML ä¸­å¼•ç”¨çš„å­ç½‘ ID æœ‰è¯¯ï¼Œå¯èƒ½æœªæ›´æ–°ä¸º Terraform å®é™…åˆ›å»ºçš„å€¼ã€‚è¯·ç™»å½• VPC æ§åˆ¶å°è·å–æ­£ç¡®çš„å­ç½‘ IDï¼Œæ›´æ–° YAML åé‡è¯•ã€‚
- **èŠ‚ç‚¹ç»„åˆ›å»ºè¶…æ—¶æˆ–èŠ‚ç‚¹æœªè¾¾æœŸæœ›æ•°ï¼š** ä½¿ç”¨ Spot å®ä¾‹æ—¶å¯èƒ½é‡åˆ°å®¹é‡ä¸è¶³æˆ–è¯·æ±‚è¶…æ—¶ã€‚å¦‚æœ eksctl æœ€ç»ˆæç¤ºèŠ‚ç‚¹ç»„ä»…å¯åŠ¨äº†éƒ¨åˆ†èŠ‚ç‚¹ï¼Œå¯åœ¨ EKS æ§åˆ¶å°æŸ¥çœ‹èŠ‚ç‚¹ç»„è¯¦æƒ…çš„äº‹ä»¶ã€‚å¦‚æœæŒç»­ Spot ä¸å¯ç”¨ï¼Œè§£å†³åŠæ³•ï¼šå¯ä»¥è°ƒæ•´å®ä¾‹ç±»å‹ï¼ˆå¦‚å¢åŠ å…¶ä»–ç±»ä¼¼è§„æ ¼çš„ instanceTypesï¼‰æˆ–æš‚æ—¶å…³é—­ Spot æ¨¡å¼ï¼ˆYAML ä¸­å°† `spot: true` æ”¹ä¸º false ä½¿ç”¨æŒ‰éœ€å®ä¾‹ï¼‰ï¼Œç„¶ååˆ é™¤é›†ç¾¤é‡å»ºã€‚
- **kubectl è¿æ¥å¤±è´¥ï¼š** è‹¥ `kubectl get nodes` æŠ¥é”™ *`could not connect to cluster`* æˆ–è¶…æ—¶ï¼Œå¯èƒ½ kubeconfig æœªæ­£ç¡®è®¾ç½®ã€‚è¯·é‡è¯•æ‰§è¡Œ `aws eks update-kubeconfig ...` å‘½ä»¤ï¼Œå¹¶ç¡®ä¿ AWS CLI ä½¿ç”¨æ­£ç¡® Profile å’Œ Regionã€‚å¦ä¸€ä¸ªå¯èƒ½åŸå› æ˜¯æœ¬åœ°ç½‘ç»œé˜²ç«å¢™é˜»æ‹¦ï¼ŒEKS éœ€è®¿é—® AWS API ç«¯ç‚¹ï¼Œè¯·ç¡®ä¿æœ¬åœ°ç½‘ç»œå¯ä»¥è®¿é—® \*.eks.amazonaws.com åŸŸåã€‚
- **ç³»ç»Ÿ Pod å¼‚å¸¸ï¼š** å¦‚æœ `aws-node` æˆ– `coredns` Pod CrashLoopï¼Œå¸¸è§åŸå› æ˜¯å°‘è£…ç½®æˆ–é…ç½®é”™è¯¯ã€‚ä¾‹å¦‚ VPC CNI æ’ä»¶éœ€è¦ç‰¹å®š IAM æƒé™ï¼ˆé€šå¸¸èŠ‚ç‚¹ IAM Role eksctl è‡ªåŠ¨åˆ›å»ºä¼šé™„åŠ ï¼Œé—®é¢˜ä¸å¤šè§ï¼‰ï¼ŒCoreDNS CrashLoop å¤šå› æ— æ³•è¿é€š cluster DNSï¼Œæ­¤æ—¶æ£€æŸ¥èŠ‚ç‚¹å­ç½‘çš„ DHCP Option æ˜¯å¦é…ç½®äº† AmazonProvidedDNSï¼ˆTerraform ä¸€èˆ¬é»˜è®¤é…ç½®æ— éœ€ç‰¹æ®Šå¤„ç†ï¼‰ã€‚
- **é›†ç¾¤åå­—å†²çªï¼š** å¦‚æœå°è¯•åˆ›å»ºçš„é›†ç¾¤åç§°åœ¨å½“å‰è´¦æˆ·åŒºåŸŸå·²å­˜åœ¨ï¼ˆå¯èƒ½å‰ä¸€å¤©å¿˜è®°åˆ æˆ–è€…æœ‰åŒåé›†ç¾¤ï¼‰ï¼Œeksctl ä¼šæŠ¥é”™ç»ˆæ­¢ã€‚å¯æ›´æ¢ metadata.name æˆ–å…ˆåˆ é™¤åŒåé›†ç¾¤ï¼š`eksctl delete cluster --name dev --region us-east-1`.

#### âœ… é˜¶æ®µå››éªŒæ”¶æ¸…å•

- [ ] **EKS é›†ç¾¤ "dev"** å·²åˆ›å»ºï¼ŒAWS æ§åˆ¶å°ä¸­é›†ç¾¤çŠ¶æ€ä¸º Activeï¼Œä¸” Kubernetes ç‰ˆæœ¬ç¬¦åˆ eksctl é…ç½®ï¼ˆä¾‹å¦‚ v1.30ï¼‰ã€‚
- [ ] **èŠ‚ç‚¹ç»„ "ng-mixed"** å·²æˆåŠŸéƒ¨ç½²ï¼ŒæœŸæœ›èŠ‚ç‚¹æ•°ä¸å®é™…è¿è¡ŒèŠ‚ç‚¹æ•°ç›¸ç¬¦ï¼ˆå…è®¸æœ‰å°‘é‡å·®å¼‚ï¼ŒSpot èŠ‚ç‚¹å¯èƒ½å»¶è¿Ÿï¼‰ã€‚EC2 æ§åˆ¶å°ä¸­èƒ½çœ‹åˆ°ç›¸åº”æ•°é‡çš„å·¥ä½œèŠ‚ç‚¹ EC2 å®ä¾‹ï¼Œå®ä¾‹ç±»å‹åŒ¹é… YAML ä¸­å®šä¹‰ (t3.small/medium)ã€‚
- [ ] **æœ¬åœ° kubeconfig å·²æ›´æ–°**ï¼Œ`kubectl config current-context` æŒ‡å‘æ–°çš„ dev é›†ç¾¤ï¼Œä¸”å¯ä»¥æ­£å¸¸é€šè¿‡ kubectl ä¸é›†ç¾¤äº¤äº’ã€‚
- [ ] `kubectl get nodes` æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹ **Ready**ï¼Œ`kubectl get pods -A` æ˜¾ç¤ºç³»ç»Ÿ Pods **Running**ï¼Œæ—  CrashLoopBackOff ç­‰å¼‚å¸¸ã€‚
- [ ] eksctl YAML ä¸­é…ç½®çš„å„é¡¹å‡ç”Ÿæ•ˆï¼šåŒ…æ‹¬ Spot é…ç½®ã€èŠ‚ç‚¹æ ‡ç­¾ã€OIDC æä¾›è€…å¯ç”¨ç­‰ã€‚OIDC æä¾›è€…å¯åœ¨ AWS IAM æ§åˆ¶å° **èº«ä»½æä¾›å•†** é¡µçœ‹åˆ°å¯¹åº”æ¡ç›®ã€‚

---

## é˜¶æ®µäº”ï¼šTerraform èµ„æºå¯¼å…¥

#### æ“ä½œç›®çš„ä¸èƒŒæ™¯

ä¸ºå®ç°åŸºç¡€è®¾æ–½çŠ¶æ€çš„ä¸€è‡´ç®¡ç†ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ eksctl åˆ›å»ºé›†ç¾¤åï¼Œéœ€è¦å°†å…¶ç›¸å…³èµ„æºå¯¼å…¥ Terraform çŠ¶æ€ã€‚è¿™æ · Terraform æ‰èƒ½â€œçŸ¥æ™“â€é›†ç¾¤çš„å­˜åœ¨å¹¶è¿›è¡Œåç»­ç®¡ç†ï¼ˆä¾‹å¦‚ IRSA è§’è‰²ç»‘å®šã€èµ„æºæ¸…å•ï¼‰ï¼Œå½¢æˆé—­ç¯çš„ **IaCï¼ˆInfrastructure as Codeï¼‰** ç®¡ç†æ¨¡å‹ã€‚æœ¬é˜¶æ®µé€šè¿‡è¿è¡Œé¢„å…ˆç¼–å†™çš„è„šæœ¬ï¼Œå°† EKS é›†ç¾¤ã€èŠ‚ç‚¹ç»„ã€OIDC æä¾›å•†ä»¥åŠ IRSA ç›¸å…³çš„ IAM è§’è‰²å¯¼å…¥ Terraformã€‚å¯¼å…¥åï¼Œæ‚¨å¯ä»¥é€šè¿‡ Terraform state æŸ¥è¯¢å’Œ plan æ¥éªŒè¯è¿™äº›èµ„æºå·²å— Terraform ç®¡ç†ï¼Œè€Œä¸ä¼šåœ¨åç»­ Terraform æ“ä½œä¸­è¢«æ„å¤–åˆ é™¤æˆ–é‡å¤åˆ›å»ºã€‚

#### æ“ä½œæ­¥éª¤

1. **è¿è¡Œå¯¼å…¥è„šæœ¬**ï¼šé¡¹ç›®ä¸­æä¾›äº† `scripts/tf-import.sh` è„šæœ¬ï¼Œå¯è‡ªåŠ¨å®Œæˆæ‰€éœ€èµ„æºçš„å¯¼å…¥ã€‚æ‰§è¡Œè¯¥è„šæœ¬ï¼š

   ```bash
   bash scripts/tf-import.sh
   ```

   è„šæœ¬å°†æ‰§è¡Œä»¥ä¸‹å¯¼å…¥æ“ä½œï¼š

   - å¯¼å…¥ **EKS é›†ç¾¤** æœ¬èº«ï¼šå°† Terraform ä¸­ `module.eks.aws_eks_cluster.this[0]` å…³è”åˆ°å½“å‰é›†ç¾¤åç§° (dev)ã€‚

   - å¯¼å…¥ **EKS æ‰˜ç®¡èŠ‚ç‚¹ç»„**ï¼šå°† Terraform ä¸­ `module.eks.aws_eks_node_group.ng[0]` å…³è”åˆ° â€œé›†ç¾¤å:èŠ‚ç‚¹ç»„åâ€ (ä¾‹å¦‚ `dev:ng-mixed`)ã€‚

   - å¯¼å…¥ **OIDC æä¾›å•†**ï¼šå°† Terraform ä¸­ `module.eks.aws_iam_openid_connect_provider.oidc[0]` å…³è”åˆ°é›†ç¾¤çš„ OIDC ARNã€‚è¯¥ ARN ç”±è„šæœ¬é€šè¿‡ AWS CLI è‡ªåŠ¨è·å–ã€‚

   - å¯¼å…¥ **IRSA è§’è‰²åŠé™„åŠ ç­–ç•¥**ï¼šåˆ†åˆ«å°† `module.irsa.aws_iam_role.eks_cluster_autoscaler` å…³è” IAM è§’è‰² **eks-cluster-autoscaler**ï¼Œä»¥åŠå°†å…¶ç­–ç•¥é™„åŠ å…³ç³»å…³è”å¯¹åº”ç­–ç•¥ ARNã€‚

   > **æ³¨æ„ï¼š** è„šæœ¬é»˜è®¤å‡è®¾é›†ç¾¤åç§°ä¸º "dev"ï¼ŒProfile ä¸º phase2-ssoã€‚å¦‚æœæ‚¨çš„é›†ç¾¤æˆ–é…ç½®ä¸åŒï¼Œè¯·åœ¨è¿è¡Œå‰ç¼–è¾‘è„šæœ¬å¼€å¤´çš„å˜é‡ã€‚å¦‚è„šæœ¬æ‰§è¡ŒæŠ¥é”™ï¼Œå¯é€ä¸ªå¯¼å…¥å‘½ä»¤æ‰‹å·¥æ‰§è¡Œå¹¶è°ƒæ•´å‚æ•°ã€‚å¯¼å…¥æ“ä½œæ˜¯å¹‚ç­‰çš„ï¼Œå¦‚æœæŸèµ„æºå·²å¯¼å…¥ä¼šæœ‰ç›¸åº”æç¤ºã€‚

1. **æ£€æŸ¥ Terraform çŠ¶æ€**ï¼šå¯¼å…¥å®Œæˆåï¼Œè¿è¡Œ Terraform çŠ¶æ€å‘½ä»¤æŸ¥çœ‹ç»“æœï¼š

   ```bash
   terraform state list | grep aws_eks_cluster
   ```

   æ‚¨åº”è¯¥çœ‹åˆ°ç±»ä¼¼ `module.eks.aws_eks_cluster.this[0]`ã€`module.eks.aws_eks_node_group.ng[0]` ç­‰æ¡ç›®å‡ºç°åœ¨çŠ¶æ€åˆ—è¡¨ä¸­ï¼Œè¡¨æ˜é›†ç¾¤å’ŒèŠ‚ç‚¹ç»„ç°å·²åœ¨ Terraform çŠ¶æ€å†…ç®¡ç†ã€‚æ­¤å¤–ï¼Œ`module.irsa.aws_iam_role.eks_cluster_autoscaler` ç­‰ IRSA ç›¸å…³èµ„æºä¹Ÿåº”å­˜åœ¨ã€‚

1. **Terraform Plan éªŒè¯ä¸€è‡´æ€§**ï¼šä¸ºäº†ç¡®ä¿å¯¼å…¥åçš„é…ç½®ä¸å®é™…åŸºç¡€è®¾æ–½ä¸€è‡´ï¼Œå»ºè®®è¿è¡Œä¸€æ¬¡ Terraform Planï¼š

   ```bash
   terraform plan -var="region=us-east-1"
   ```

   ç†æƒ³æƒ…å†µä¸‹ï¼ŒPlan è¾“å‡ºåº”æ˜¾ç¤º **0 to add, 0 to change, 0 to destroy**ï¼Œè¡¨ç¤ºæ‰€æœ‰çŠ¶æ€å‡åŒ¹é…ï¼ˆæˆ–è€…ä»…æœ‰é¢„æœŸçš„å˜æ›´ï¼Œæ¯”å¦‚æ ‡ç­¾æ›´æ–°ç­‰æ— å®³å˜æ›´ï¼‰ã€‚å¦‚æœ Plan åˆ—å‡ºäº†å¯¹ EKS æˆ– NodeGroup èµ„æºçš„ä¿®æ”¹/é”€æ¯è®¡åˆ’ï¼Œåˆ™å¯èƒ½å¯¼å…¥æœ‰è¯¯æˆ– Terraform æ¨¡å—å®šä¹‰ä¸å®é™…é…ç½®ä¸å®Œå…¨åŒ¹é…ã€‚éœ€äººå·¥æ£€æŸ¥ Terraform é…ç½®å’Œå®é™… AWS èµ„æºå±æ€§ï¼Œè°ƒæ•´ä»£ç ä½¿äºŒè€…ä¸€è‡´ï¼Œç„¶åé€šè¿‡ `terraform apply` ä½¿çŠ¶æ€åŒæ­¥ã€‚å¸¸è§çš„ç»†å¾®ä¸ä¸€è‡´åŒ…æ‹¬æ ‡ç­¾å·®å¼‚ã€Launch Template ç‰ˆæœ¬å·ç­‰ï¼Œé€šå¸¸å¯åœ¨ Terraform é…ç½®ä¸­æ›´æ–°ç›¸åº”å‚æ•°è§£å†³ã€‚

#### éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º

- **å¯¼å…¥è„šæœ¬è¾“å‡ºï¼š** è„šæœ¬è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ª `terraform import` æ‰§è¡ŒæˆåŠŸåä¼šæç¤º **Import successful!** æˆ–æ²¡æœ‰é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œä¼šæœ‰ç›¸åº”é”™è¯¯è¾“å‡ºï¼ˆå¦‚ "No such resource" ç­‰ï¼‰ã€‚

- **Terraform çŠ¶æ€åˆ—è¡¨ï¼š** è¿è¡Œ `terraform state list` ååº”åŒ…å«ä»¥ä¸‹å…³é”®æ¡ç›®ï¼š

  ```
  module.eks.aws_eks_cluster.this[0]
  module.eks.aws_eks_node_group.ng[0]
  module.eks.aws_iam_openid_connect_provider.oidc[0]
  module.irsa.aws_iam_role.eks_cluster_autoscaler
  module.irsa.aws_iam_role_policy_attachment.cluster_autoscaler_attach
  ```

  è¿™äº›å¯¹åº” EKS é›†ç¾¤ã€èŠ‚ç‚¹ç»„ã€OIDC æä¾›å•†ã€IRSA è§’è‰²åŠç­–ç•¥é™„åŠ å…³ç³»ã€‚ç¡®è®¤ `eks_cluster_autoscaler` è§’è‰²å’Œç­–ç•¥å…³è”å‡å·²å¯¼å…¥ï¼ˆå¯¹åº”æˆ‘ä»¬åœ¨é˜¶æ®µä¸‰åˆ›å»ºçš„ IAM è§’è‰²å’Œç­–ç•¥ï¼‰ã€‚

- **Terraform Plan è¾“å‡ºï¼š** ç†æƒ³è¾“å‡ºä¸ºï¼š

  ```
  No changes. Infrastructure is up-to-date.
  ```

  å¦‚æœæœ‰å˜åŒ–æç¤ºï¼Œä¹Ÿåº”æ—  **destroy** æ“ä½œï¼Œä¸” **create/modify** ä»…é™äºæ‚¨çŸ¥æ™“çš„å¿…è¦è°ƒæ•´ï¼ˆæ¯”å¦‚ç»™èµ„æºè¡¥å……æ ‡ç­¾ç­‰ï¼‰ã€‚å‡ºç° destroy è¦ç‰¹åˆ«è­¦æƒ•ï¼Œé¿å…è¯¯åˆ ç°æœ‰èµ„æºã€‚

#### å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰

- **å¯¼å…¥è„šæœ¬å¤±è´¥ï¼š** å¦‚æœ `tf-import.sh` è„šæœ¬æœªæˆåŠŸè¿è¡Œï¼Œæ‚¨å¯ä»¥é€æ­¥æ‰§è¡Œå…¶ä¸­å‘½ä»¤å¹¶æŸ¥çœ‹é—®é¢˜ã€‚ä¾‹å¦‚å¯¼å…¥ NodeGroup æ—¶å¸¸è§é”™è¯¯ï¼š

  - *No nodegroup found*: è„šæœ¬é€šè¿‡ AWS CLI `list-nodegroups` è·å–èŠ‚ç‚¹ç»„åç§°ã€‚è‹¥æ‚¨çš„é›†ç¾¤åç§°æˆ– Profile ä¸åŒä¼šå¯¼è‡´ç©ºç»“æœã€‚è§£å†³ï¼šç›´æ¥æŒ‡å®šèŠ‚ç‚¹ç»„åç§°å¯¼å…¥ï¼Œä¾‹å¦‚ï¼š

    ```bash
    terraform import 'module.eks.aws_eks_node_group.ng[0]' dev:ng-mixed
    ```

    å°† `dev` å’Œ `ng-mixed` æ›¿æ¢ä¸ºæ‚¨çš„å®é™…é›†ç¾¤åå’ŒèŠ‚ç‚¹ç»„åã€‚

  - *Resource already managed*: å¦‚æœä¹‹å‰å·²ç»å¯¼å…¥è¿‡ï¼ŒTerraform ä¼šæ‹’ç»é‡å¤å¯¼å…¥ç›¸åŒå®ä½“ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `terraform state show <resource>` æŸ¥çœ‹å…¶å½“å‰çŠ¶æ€ï¼Œæˆ–ç”¨ `terraform state rm <resource>` ç§»é™¤å†²çªçš„çŠ¶æ€åé‡æ–°å¯¼å…¥ï¼ˆè°¨æ…æ“ä½œï¼‰ã€‚

- **Launch Template ID å˜æ›´æœªæ•è·ï¼š** ç”±äº eksctl åˆ›å»ºçš„èŠ‚ç‚¹ç»„ä½¿ç”¨äº† Launch Templateï¼ŒTerraform é…ç½®ä¸­å¯èƒ½éœ€è¦è¯¥ Launch Template IDã€‚å½“å‰ Terraform æ¨¡å—é‡Œ Launch Template ID æ˜¯ç¡¬ç¼–ç å€¼ã€‚å¦‚æœé›†ç¾¤é‡å»ºå¯¼è‡´ Launch Template ID æ›´æ–°ï¼ŒTerraform plan ä¼šè¯•å›¾è°ƒæ•´å›æ—§å€¼ï¼ˆæˆ–è®¤ä¸ºä¸ä¸€è‡´ï¼‰ã€‚

  - **ğŸ’¡ ä¿®å¤å»ºè®®ï¼š** å°† Launch Template ç›¸å…³é…ç½®æ”¹ä¸ºé€šè¿‡æ•°æ®æºæˆ–å˜é‡ä¼ å…¥ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç å…·ä½“ IDã€‚ç›®å‰æ‰‹åŠ¨è§£å†³åŠæ³•ï¼šæ›´æ–° Terraform é…ç½®ä¸­çš„ `launch_template.id` ä¸ºæ–°çš„ Launch Template IDï¼ˆå¯åœ¨ AWS EC2 æ§åˆ¶å°çš„ Launch Templates ä¸­æ‰¾åˆ° dev èŠ‚ç‚¹ç»„å¯¹åº”çš„æ¨¡æ¿ï¼‰ã€‚

- **èŠ‚ç‚¹ IAM Role ARN ä¸åŒ¹é…ï¼š** ç±»ä¼¼åœ°ï¼Œæ‰˜ç®¡èŠ‚ç‚¹ç»„çš„èŠ‚ç‚¹è§’è‰² ARN ä¹Ÿåœ¨ Terraform é…ç½®ä¸­å›ºå®šä¸ºäº†é¦–æ¬¡åˆ›å»ºæ—¶çš„å€¼ã€‚å¦‚æœæ¯æ¬¡é‡å»ºé›†ç¾¤è¯¥ ARN å‘ç”Ÿå˜åŒ–ï¼ˆå¦‚ eksctl æœªå¤ç”¨æ—§è§’è‰²ï¼‰ï¼ŒTerraform å¯èƒ½æŠ¥å‘Šå·®å¼‚ã€‚è§£å†³ï¼šå¯ä»¥åœ¨ eksctl åˆ›å»ºé›†ç¾¤æ—¶æŒ‡å®šå¤ç”¨å·²æœ‰èŠ‚ç‚¹è§’è‰²ï¼Œæˆ–åœ¨ Terraform ä¸­å°† `node_role_arn` å‚æ•°æ”¹ä¸ºå˜é‡ï¼Œé€šè¿‡å¯¼å…¥æ­¥éª¤è·å–å®é™…çš„è§’è‰² ARN åèµ‹å€¼ã€‚æ‰‹å†Œæ‰§è¡Œä¸­ï¼Œå¦‚é‡ä¸åŒ¹é…ï¼Œå¯æ‰‹åŠ¨ç¼–è¾‘ Terraform é…ç½®æ–‡ä»¶ `infra/aws/modules/eks/main.tf`ï¼Œæ›´æ–°ç¬¬ 37 è¡Œçš„ ARN ä¸ºæ–°å€¼ã€‚è¿™å±äºä»£ç ä¼˜åŒ–èŒƒç•´ï¼Œå®é™…æ¼”ç»ƒæ—¶æ³¨æ„ä¿æŒæ­¤å€¼åŒæ­¥æœ€æ–°ã€‚

- **OIDC æä¾›å•†å¯¼å…¥é—®é¢˜ï¼š** å¦‚æœå¯¼å…¥ OIDC æä¾›å•†æ—¶æŠ¥ ARN ä¸æ­£ç¡®ï¼Œå¯ç™»å½• IAM æ§åˆ¶å° -> èº«ä»½æä¾›å•†ï¼Œæ‰¾åˆ°ç±»ä¼¼ `oidc.eks.<region>.amazonaws.com/id/XXXX` çš„æä¾›è€… ARNï¼Œç¡®è®¤è„šæœ¬ç»„è£…çš„ ARN æ˜¯å¦ä¸€è‡´ã€‚å¦‚ä¸ä¸€è‡´ï¼Œå¯æ‰‹åŠ¨æ‰§è¡Œ importï¼š

  ```bash
  terraform import module.eks.aws_iam_openid_connect_provider.oidc[0] arn:aws:iam::<AccountID>:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/XXXX
  ```

  å°† AccountID å’Œ XXXX æ›¿æ¢ä¸ºå®é™…å€¼ã€‚

- **Terraform Plan éé¢„æœŸæ›´æ”¹ï¼š** å¦‚æœ Plan æ˜¾ç¤ºéœ€è¦æ–°å»ºæˆ–é”€æ¯èµ„æºï¼ˆå°¤å…¶ EKS ç±»èµ„æºï¼‰ï¼ŒåŠ¡å¿…ä¸‰æ€åå†æ‰§è¡Œã€‚é€šå¸¸å¯¼å…¥å®Œæˆå³åº”æ— å·®å¼‚ã€‚å¦‚å‡ºç°ï¼Œå¯æ£€æŸ¥ Terraform ç‰ˆæœ¬ã€AWS Provider ç‰ˆæœ¬å…¼å®¹æ€§æˆ–æ¨¡å— bugsã€‚ä¾‹å¦‚ Terraform 1.x å¯¹ AWS EKS æœ‰äº›æ–°å­—æ®µé»˜è®¤å€¼ï¼Œå¿…è¦æ—¶åœ¨ Terraform é…ç½®ä¸­æ˜¾å¼æ·»åŠ è¿™äº›å­—æ®µä»¥æ¶ˆé™¤è™šå‡å·®å¼‚ï¼Œç„¶åå†æ¬¡ plan ç¡®è®¤ã€‚

#### âœ… é˜¶æ®µäº”éªŒæ”¶æ¸…å•

- [ ] å·²æ‰§è¡Œ `tf-import.sh` æˆ–ç­‰æ•ˆçš„ Terraform Import æ“ä½œï¼ŒEKS é›†ç¾¤ã€èŠ‚ç‚¹ç»„ã€OIDC Providerã€IRSA è§’è‰²åŠç­–ç•¥ç»‘å®šç­‰èµ„æºæˆåŠŸå¯¼å…¥ Terraform çŠ¶æ€ã€‚
- [ ] `terraform state list` å¯ä»¥åˆ—å‡º EKS é›†ç¾¤ (`aws_eks_cluster`)ã€èŠ‚ç‚¹ç»„ (`aws_eks_node_group`)ã€OIDC æä¾›å•† (`aws_iam_openid_connect_provider`) ä»¥åŠ IRSA ç›¸å…³ IAM èµ„æº (`aws_iam_role` å’Œ `aws_iam_role_policy_attachment`)ã€‚
- [ ] è¿è¡Œ Terraform Plan æ˜¾ç¤ºæ— éœ€é¢å¤–å˜æ›´ï¼ˆæˆ–ä»…æœ‰å°‘é‡å¯æ¥å—çš„ä¿®æ”¹ï¼‰ï¼Œè¯æ˜ Terraform é…ç½®ä¸å®é™…åŸºç¡€è®¾æ–½çŠ¶æ€ä¸€è‡´ã€‚ç‰¹åˆ«åœ°ï¼Œæ²¡æœ‰ **é”€æ¯ (destroy)** EKS é›†ç¾¤æˆ–èŠ‚ç‚¹ç»„çš„è®¡åˆ’ã€‚
- [ ] Terraform çŠ¶æ€æ–‡ä»¶å·²å¤‡ä»½åˆ°è¿œç«¯ï¼ˆS3ï¼‰ï¼Œç¡®ä¿å³ä½¿æœ¬åœ°ç¯å¢ƒä¸¢å¤±ä¹Ÿå¯æ¢å¤çŠ¶æ€ã€‚å¯¼å…¥æ“ä½œæ—¥å¿—ï¼ˆå¦‚ tf-import.sh è¾“å‡ºï¼‰å¦¥å–„ä¿å­˜ï¼Œä»¥ä¾›æ—¥åæ’æŸ¥å‚è€ƒã€‚
- [ ] é’ˆå¯¹ Terraform è„šæœ¬ä¸­ç¡¬ç¼–ç çš„ AWS èµ„æº ID/ARNï¼ˆå¦‚ Launch Templateã€IAM ç­–ç•¥ç­‰ï¼‰å·²æœ‰è®°å½•æˆ–æ”¹è¿›æ–¹æ¡ˆï¼Œé¿å…ä¸‹æ¬¡é‡å»ºæ—¶å‡ºç°ä¸åŒ¹é…é—®é¢˜ã€‚å·²ç»è€ƒè™‘å¯¹ Makefile æˆ–è„šæœ¬è¿›è¡Œæ”¹è¿›ï¼ˆä¾‹å¦‚å¢åŠ  `stop-hard` å‘½ä»¤ï¼‰ä»¥å®Œå–„æ—¥å¸¸é‡å»ºæµç¨‹ã€‚

---

## é˜¶æ®µå…­ï¼šCluster Autoscaler å®‰è£…

#### æ“ä½œç›®çš„ä¸èƒŒæ™¯

ç°åœ¨ EKS é›†ç¾¤å·²ç»è¿è¡Œï¼Œæˆ‘ä»¬å°†éƒ¨ç½² **Kubernetes Cluster Autoscalerï¼ˆé›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©å™¨ï¼‰** æ¥æ ¹æ®å·¥ä½œè´Ÿè½½è‡ªåŠ¨å¢å‡èŠ‚ç‚¹æ•°é‡ã€‚é€šè¿‡ Autoscalerï¼Œå¯ä»¥åœ¨é›†ç¾¤ Pod è°ƒåº¦å¤±è´¥ï¼ˆå› èŠ‚ç‚¹ä¸è¶³ï¼‰æ—¶è‡ªåŠ¨æ·»åŠ èŠ‚ç‚¹ï¼Œåœ¨é—²ç½®æ—¶è‡ªåŠ¨ç§»é™¤èŠ‚ç‚¹ï¼Œå®ç°å¼¹æ€§ä¼¸ç¼©ä»¥ä¼˜åŒ–æˆæœ¬å’Œæ€§èƒ½ã€‚æœ¬é˜¶æ®µä¸»è¦å†…å®¹ï¼š

- ä½¿ç”¨ä¹‹å‰ä¸º Cluster Autoscaler å‡†å¤‡çš„ IRSA æœåŠ¡è´¦æˆ·ï¼ˆ`kube-system:cluster-autoscaler`ï¼‰éƒ¨ç½² Autoscaler åº”ç”¨ã€‚Autoscaler Pod å°†ä»¥è¯¥æœåŠ¡è´¦æˆ·è¿è¡Œï¼Œå¹¶é€šè¿‡å…¶å…³è”çš„ IAM Role æ¥è°ƒç”¨ AWS çš„ Auto Scaling APIï¼Œå®ç°å¯¹ EKS æ‰˜ç®¡èŠ‚ç‚¹ç»„ï¼ˆå®é™…ä¸Šæ˜¯ Auto Scaling Groupï¼‰çš„æ‰©ç¼©å®¹æ“ä½œã€‚
- é…ç½® Autoscaler ä½¿å…¶è¯†åˆ«é›†ç¾¤å’ŒèŠ‚ç‚¹ç»„ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ EKS æ‰˜ç®¡èŠ‚ç‚¹ç»„ (Managed Node Group)ï¼ŒAutoscaler å¯ä»¥é€šè¿‡ **AutoDiscovery** æ¨¡å¼è‡ªåŠ¨å‘ç° ASGã€‚æˆ‘ä»¬éœ€æä¾›é›†ç¾¤åç§°å’Œä¸€äº›å‚æ•°ç»™ Autoscalerï¼Œä»¥ç¡®ä¿å®ƒåªç®¡ç†ç‰¹å®šèŠ‚ç‚¹ç»„å¹¶éµå®ˆæˆ‘ä»¬è®¾å®šçš„ç¼©å®¹è§„åˆ™ã€‚

#### æ“ä½œæ­¥éª¤

1. **ä¸‹è½½ Cluster Autoscaler éƒ¨ç½² YAMLï¼š** Kubernetes å®˜æ–¹ä»“åº“æä¾›äº† AWS ä¸“ç”¨çš„ Cluster Autoscaler éƒ¨ç½²ç¤ºä¾‹ã€‚è¿è¡Œä»¥ä¸‹å‘½ä»¤è·å–æœ€æ–°ç‰ˆæœ¬çš„ YAML æ¸…å•ï¼š

   ```bash
   curl -O https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml
   ```

   è¿™å°†ä¸‹è½½åä¸º `cluster-autoscaler-autodiscover.yaml` çš„æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« Cluster Autoscaler çš„ Deployment å®šä¹‰ç­‰ã€‚ç”¨ç¼–è¾‘å™¨æ‰“å¼€æ­¤æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦åšå‡ ç‚¹ä¿®æ”¹ï¼š

   - åœ¨ Deployment çš„ spec.template.spec.containers.args ä¸‹ï¼Œæ‰¾åˆ° `--cluster-name=<YOUR CLUSTER NAME>`ï¼Œå°†å…¶å€¼æ›¿æ¢ä¸º **dev**ï¼ˆæ‚¨çš„é›†ç¾¤åç§°ï¼‰ã€‚

   - ç¡®è®¤ Deployment çš„ spec.template.spec.containers.image ä½¿ç”¨çš„ç‰ˆæœ¬ä¸æ‚¨çš„é›†ç¾¤ K8s ç‰ˆæœ¬å…¼å®¹ã€‚ä¾‹å¦‚ï¼Œå¯¹äº Kubernetes 1.30ï¼Œå¯ä½¿ç”¨ autoscaler é•œåƒ tag `v1.30.n`ï¼ˆn ä¸ºæœ€æ–°å°ç‰ˆæœ¬ï¼‰ã€‚å®˜æ–¹ YAML å¯èƒ½ä½¿ç”¨ `latest` æˆ–è¾ƒè€ç‰ˆæœ¬ï¼Œè¯·é…Œæƒ…è°ƒæ•´é•œåƒæ ‡ç­¾ä»¥åŒ¹é… Kubernetes ç‰ˆæœ¬ã€‚

   - å°† Deployment spec.template.spec ä¸­æ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡å‚æ•°ï¼Œä»¥è®¾ç½®ç¼©å®¹è¡Œä¸ºï¼š

     ```yaml
     - name: AWS_REGION
       value: us-east-1
     - name: TZ
       value: Asia/Shanghai         # å¯é€‰ï¼Œè®¾ç½®æ—¶åŒºä»¥ä¾¿æ—¥å¿—æŒ‰å½“åœ°æ—¶é—´
     ```

     åŒæ—¶ï¼Œåœ¨ args éƒ¨åˆ†æ·»åŠ  `--balance-similar-node-groups` å’Œ `--skip-nodes-with-system-pods=false` ç­‰å‚æ•°ï¼Œä»¥å¯ç”¨æ›´æ™ºèƒ½çš„å‡è¡¡æ‰©å®¹å’Œå…è®¸ç¼©å®¹è‡³ 0 èŠ‚ç‚¹ã€‚å®Œæ•´ args ç¤ºä¾‹ï¼š

     ```yaml
       args:
         - --cloud-provider=aws
         - --cluster-name=dev
         - --namespace=kube-system
         - --balance-similar-node-groups
         - --skip-nodes-with-system-pods=false
         - --logtostderr=true
         - --stderrthreshold=info
         - --v=4
     ```

   - **æœåŠ¡è´¦æˆ·ä¸ IRSAï¼š** YAML é»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ª ServiceAccount `cluster-autoscaler` åœ¨ `kube-system` å‘½åç©ºé—´ã€‚ç”±äºæˆ‘ä»¬å·²æå‰åˆ›å»ºå¯¹åº”çš„ IAM Roleï¼ˆeks-cluster-autoscalerï¼‰ä¿¡ä»»è¯¥ SAï¼Œæˆ‘ä»¬éœ€è¦å°†æ­¤ ServiceAccount ä¸ IAM Role ç»‘å®šã€‚æ–¹æ³•æ˜¯åœ¨ ServiceAccount å®šä¹‰ä¸‹æ·»åŠ æ³¨è§£ï¼š

     ```yaml
     apiVersion: v1
     kind: ServiceAccount
     metadata:
       name: cluster-autoscaler
       namespace: kube-system
       annotations:
         eks.amazonaws.com/role-arn: arn:aws:iam::<AccountID>:role/eks-cluster-autoscaler
     ```

     å°† `<AccountID>` æ›¿æ¢ä¸ºæ‚¨ AWS è´¦æˆ· IDã€‚æ­¤æ³¨è§£ä½¿ Autoscaler Pod å¯åŠ¨æ—¶ï¼Œé€šè¿‡ IRSA è·å¾— eks-cluster-autoscaler è§’è‰²æƒé™ã€‚

   - æ·»åŠ ä¸€ä¸ªä¿è¯ Pod ä¸è¢«é©±é€çš„æ³¨è§£ï¼šåœ¨ Deployment çš„ metadata.annotations ä¸‹æ·»åŠ ï¼š

     ```yaml
     cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
     ```

     ä»¥é˜²æ­¢ Autoscaler è‡ªèº«å› ç©ºé—²è¢«é©±é€ã€‚

1. **åº”ç”¨ YAML éƒ¨ç½² Autoscalerï¼š** ä¿å­˜ç¼–è¾‘åçš„ YAML æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œï¼š

   ```bash
   kubectl apply -f cluster-autoscaler-autodiscover.yaml
   ```

   Kubernetes å°†åˆ›å»º **cluster-autoscaler** Deploymentï¼ˆä½äº kube-systemï¼‰ï¼Œä»¥åŠå…³è”çš„ ServiceAccount ç­‰èµ„æºã€‚ç­‰å¾…å‡ ç§’åï¼Œæ£€æŸ¥ Pod çŠ¶æ€ï¼š

   ```bash
   kubectl -n kube-system get pods | grep cluster-autoscaler
   ```

   åº”å‡ºç° **cluster-autoscaler-**\* å¼€å¤´çš„ Pod åç§°ã€‚å‡ åˆ†é’Ÿå†…å…¶çŠ¶æ€åº”å˜ä¸º **Running**ã€‚åˆæ¬¡å¯åŠ¨æ—¶å¯èƒ½éœ€è¦æ‹‰å–é•œåƒï¼Œè€å¿ƒç­‰å¾…ã€‚å¦‚æœé•œåƒæ‹‰å–ç¼“æ…¢ï¼Œå¯ä»¥è€ƒè™‘åˆ‡æ¢å›½å†…æºæˆ–é€šè¿‡æå‰ä¸‹è½½é•œåƒç­‰æ–¹å¼ã€‚

1. **éªŒè¯ Autoscaler å·¥ä½œçŠ¶æ€**ï¼šæŸ¥çœ‹ Autoscaler æ—¥å¿—ä»¥ç¡®è®¤æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

   ```bash
   kubectl -n kube-system logs -f deployment/cluster-autoscaler
   ```

   åœ¨æ—¥å¿—ä¸­æœç´¢å…³é”®è¯ `Registered ASG` æˆ– `node group`ï¼Œåº”è¯¥çœ‹åˆ° Autoscaler å‘ç°äº†æˆ‘ä»¬çš„èŠ‚ç‚¹ç»„ï¼ˆAuto Scaling Groupï¼‰å¹¶å¼€å§‹ç›‘æ§ã€‚ä¾‹å¦‚æ—¥å¿—å¯èƒ½åŒ…å«ï¼š

   ```
   I... Cluster Autoscaler 1.30.x starting
   I... Registered ASG eksctl-dev-nodegroup-ng-mixed-NodeGroup-ABCDEF123456
   ```

   è¿™è¡¨ç¤º Autoscaler å·²æ£€æµ‹åˆ° dev é›†ç¾¤ä¸‹åä¸º ng-mixed çš„èŠ‚ç‚¹ç»„ã€‚åŒæ—¶, å®ƒä¼šå‘¨æœŸæ€§æ‰“å°å½“å‰é›†ç¾¤èµ„æºä½¿ç”¨ä¸æ‰©ç¼©å®¹åˆ¤æ–­ä¿¡æ¯ã€‚å½“æ‚¨éƒ¨ç½²æ–°çš„åº”ç”¨ä½¿ Pod æ— æ³•è°ƒåº¦ï¼ˆPendingï¼‰æ—¶ï¼Œæ—¥å¿—åº”å‡ºç° scale-up è§¦å‘çš„è®°å½•ï¼›å½“èŠ‚ç‚¹é•¿æ—¶é—´ç©ºé—²ä¸”æ»¡è¶³ç¼©å‡æ¡ä»¶æ—¶ï¼Œä¼šè®°å½• scale-down æ“ä½œã€‚æ‚¨å¯ä»¥é€šè¿‡æ¨¡æ‹Ÿè´Ÿè½½ï¼ˆéƒ¨ç½²ä¸€ä¸ªè¶…é¢è¯·æ±‚èµ„æºçš„ Deploymentï¼‰æ¥æµ‹è¯• Autoscaler åŠŸèƒ½ã€‚

#### éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º

- **Deployment çŠ¶æ€ï¼š** æ‰§è¡Œ `kubectl -n kube-system get deployment cluster-autoscaler -o wide`ï¼Œåº”æ˜¾ç¤º READY åˆ—ä¸º `1/1`ï¼Œè¡¨ç¤º 1 ä¸ªå‰¯æœ¬å…¨éƒ¨å°±ç»ªã€‚ServiceAccount ç»‘å®šæ­£ç¡®çš„è¯ï¼Œå¯é€šè¿‡ `kubectl -n kube-system describe pod <cluster-autoscaler-pod>` æŸ¥çœ‹ **Annotations** éƒ¨åˆ†ï¼Œèƒ½çœ‹åˆ°æˆ‘ä»¬è®¾ç½®çš„ `eks.amazonaws.com/role-arn: arn:aws:iam::<AccountID>:role/eks-cluster-autoscaler`ã€‚

- **Pod æ—¥å¿—ï¼š** é€šè¿‡ `kubectl logs` æŸ¥çœ‹æ—¥å¿—ï¼Œæ­£å¸¸æƒ…å†µä¸‹æ— é”™è¯¯å †æ ˆæˆ–æƒé™æŠ¥é”™ã€‚æœ‰å…³é”®å‡ è¡Œéœ€æ³¨æ„ï¼š

  - **å¯åŠ¨ä¿¡æ¯ï¼š** æ˜¾ç¤º Autoscaler ç‰ˆæœ¬å’Œå‚æ•°åˆ—è¡¨ï¼Œç¡®è®¤å‚æ•°å¦‚ `--cluster-name=dev` ç”Ÿæ•ˆã€‚
  - **IAM æƒé™æ£€æŸ¥ï¼š** å¦‚æœ IRSA æˆåŠŸï¼Œæ—¥å¿—ä¸ä¼šæœ‰æƒé™ç›¸å…³æŠ¥é”™ï¼›å¦åˆ™ä¼šå‡ºç°å¯¹ Auto Scaling API è°ƒç”¨è¢«æ‹’ç»çš„ä¿¡æ¯ï¼Œéœ€è¦æ£€æŸ¥ IRSA é…ç½®ã€‚
  - **å‘ç°èŠ‚ç‚¹ç»„ï¼š** æ—¥å¿—åˆ—å‡ºå·²å‘ç°çš„ ASG åç§° (é€šå¸¸ä¸º eksctl åˆ›å»ºçš„ ASGï¼ŒåŒ…å«èŠ‚ç‚¹ç»„å)ã€‚
  - **è¿è¡Œå‘¨æœŸ**ï¼š é»˜è®¤æ¯ 10 ç§’ Autoscaler è¯„ä¼°ä¸€æ¬¡ã€‚å¦‚é›†ç¾¤çŠ¶æ€ç¨³å®šï¼Œæ—¥å¿—å¤šä¸º "No unschedulable pods" æˆ– "Scale down evaluation: node X marked as unneeded" ç­‰ä¿¡æ¯ã€‚

- **åŠŸèƒ½æµ‹è¯• (å¯é€‰)ï¼š** éƒ¨ç½²ä¸€ä¸ªè¶…å‡ºå½“å‰èŠ‚ç‚¹å®¹é‡çš„åº”ç”¨ã€‚ä¾‹å¦‚åˆ›å»ºä¸€ä¸ª Deployment è¯·æ±‚ 4 ä¸ª vCPUï¼Œè€Œç›®å‰ 3 ä¸ª t3.small èŠ‚ç‚¹ä¸å¤Ÿå®¹çº³ï¼Œåˆ™ä¼šæœ‰ Pod Pendingã€‚å‡ åˆ†é’Ÿå†… Autoscaler åº”æ£€æµ‹åˆ° unschedulable pods å¹¶åœ¨æ—¥å¿—ä¸­è¾“å‡ºæ‰©å®¹å†³ç­–ï¼Œç„¶åé€šè¿‡ EKS æ·»åŠ æ–°èŠ‚ç‚¹ï¼ˆæ­¤è¿‡ç¨‹å¯åœ¨ EKS æ§åˆ¶å°çš„èŠ‚ç‚¹ç»„æ´»åŠ¨ä¸­çœ‹åˆ° scale-up è®°å½•ï¼‰ã€‚å¾…æ–°èŠ‚ç‚¹å°±ç»ªï¼ŒPending Pod å˜ä¸º Runningï¼ŒAutoscaler æ—¥å¿—ä¼šè®°å½•æˆåŠŸæ‰©å®¹ã€‚ç›¸ååœ°ï¼Œåˆ é™¤è¯¥ Deployment åï¼Œçº¦ 10 åˆ†é’Ÿå Autoscaler ä¼šè¯„ä¼°ç¼©å®¹ï¼Œè‹¥èŠ‚ç‚¹ç©ºé—²æ»¡è¶³æ¡ä»¶ä¼šç§»é™¤å¤šä½™èŠ‚ç‚¹ï¼ˆèŠ‚ç‚¹ä¼šé€æ¸å˜ä¸º NotReady -> åˆ é™¤ï¼‰ã€‚

#### å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰

- **Autoscaler Pod CrashLoopBackOffï¼š** æ‰§è¡Œ `kubectl describe pod` æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚å¦‚æœé•œåƒæ‹‰å–å¤±è´¥ï¼Œæ£€æŸ¥ç½‘ç»œæˆ–æ›´æ¢é•œåƒä»“åº“ã€‚å¦‚æœé”™è¯¯æ˜¯ **permission denied** ä¹‹ç±»ï¼Œå¯èƒ½ IRSA æœªç”Ÿæ•ˆï¼ŒPod æ— æ³•è°ƒç”¨ AWS APIã€‚è¯·ç¡®ä¿ ServiceAccount åç§°ã€å‘½åç©ºé—´å’Œ IAM è§’è‰²ä¿¡ä»»ä¸­çš„æ¡ä»¶å®Œå…¨åŒ¹é…ä¸”å·²åŠ æ³¨è§£ç»‘å®šè§’è‰² ARNã€‚ä¹Ÿå¯æ£€æŸ¥ AWS CloudWatch Logs ä¸­æ˜¯å¦æœ‰ Autoscaler æƒé™é”™è¯¯è®°å½•ï¼Œå®šä½é—®é¢˜ã€‚
- **æœªå‘ç° ASGï¼š** æ—¥å¿—æŒç»­æç¤º *â€œFailed to discover ASG: ...â€* ä¹‹ç±»ï¼Œå¯èƒ½æ˜¯ cluster-autoscaler å‚æ•°ä¸æ­£ç¡®ã€‚ç¡®ä¿ä½¿ç”¨äº† `--cloud-provider=aws` å’Œ `--cluster-name=dev`ï¼Œåç§°å¿…é¡»ä¸å®é™… EKS é›†ç¾¤åå®Œå…¨ä¸€è‡´ã€‚ä¹Ÿç¡®è®¤èŠ‚ç‚¹ç»„ç¡®å®å¤„äº**è‡ªåŠ¨ä¼¸ç¼©ç»„**æ¨¡å¼ï¼ˆManaged Node Group æœ¬è´¨ä¸Šä¼šæœ‰ä¸€ä¸ªéšå«çš„ ASGï¼Œç”± eksctl åˆ›å»ºï¼‰ã€‚é€šè¿‡ AWS EC2 æ§åˆ¶å°çš„ Auto Scaling Groupsï¼Œå¯ä»¥çœ‹åˆ°åç§°ç±»ä¼¼ *eksctl-dev-nodegroup-ng-mixed-NodeGroup-...* çš„ ASGã€‚Autoscaler åªæœ‰æ£€æµ‹åˆ°å®ƒæ‰ä¼šå·¥ä½œã€‚
- **æ‰©å®¹ä¸èµ·ä½œç”¨ï¼š** è‹¥æœ‰ Pending Pod è€Œ Autoscaler æœªååº”ï¼Œå¯èƒ½ Pod è®¾ç½®äº† `cluster-autoscaler.kubernetes.io/safe-to-evict: "false"` æˆ– Pod æœ‰æœ¬åœ°å­˜å‚¨ï¼Œé»˜è®¤ç­–ç•¥ä¸é©±é€å¸¦æœ¬åœ°å­˜å‚¨ Podï¼Œå¯¼è‡´ä¸è§¦å‘æ‰©å®¹ã€‚å¯ä»¥é€šè¿‡ç»™ Deployment æ·»åŠ  `tolerations` å…è®¸è°ƒåº¦å¤±è´¥ï¼Œæˆ–è€…åœ¨ Autoscaler å‚æ•°ä¸­è°ƒæ•´ `--expendable-pods-priority-cutoff` ç­‰ã€‚åŸºæœ¬æ¼”ç»ƒä¸­ä¸æ·±å…¥æ­¤é¡¹ã€‚
- **ç¼©å®¹ä¸èµ·ä½œç”¨ï¼š** å¦‚æœèŠ‚ç‚¹é•¿æœŸç©ºé—²å´æœªç¼©å®¹ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ Deployment çš„ replicasets å§‹ç»ˆåœ¨æ¯ä¸ªèŠ‚ç‚¹ç•™æœ‰ä¸€ä¸ª Podï¼ˆå³ **Pod åäº²å’Œ** æˆ– DaemonSet ç­‰ï¼‰ï¼Œé»˜è®¤ç­–ç•¥ä¸ä¼šç¼©å‡å¯¼è‡´é©±é€ç³»ç»Ÿ Pod æˆ– DaemonSet Pod çš„èŠ‚ç‚¹ã€‚éœ€è¦å…è®¸æ­¤ç±»ç¼©å®¹éœ€è®¾ç½® `--skip-nodes-with-system-pods=false`ï¼ˆæˆ‘ä»¬å·²ç»è®¾ç½®ï¼‰ä»¥åŠ `--skip-nodes-with-local-storage=false` è§†æƒ…å†µè€Œå®šã€‚
- **æ—¶é—´ä¸åŒæ­¥è­¦å‘Šï¼š** æ—¥å¿—å¯èƒ½æœ‰ *â€œNode not foundâ€* æˆ–ç±»ä¼¼è­¦å‘Šï¼Œå¤šç”±äºå¯åŠ¨åˆæœŸä¿¡æ¯æœªå®Œå…¨åŒæ­¥ï¼Œå¯å¿½ç•¥ã€‚å¦å¦‚æœæœ¬åœ°æ—¶åŒºä¸ UTC ä¸åŒï¼Œå¯é€šè¿‡ TZ ç¯å¢ƒå˜é‡è°ƒæ•´æ—¥å¿—æ—¶åŒºï¼Œæˆ–å¿½ç•¥æ—¶åŒºå·®å¼‚å¯¹åŠŸèƒ½æ— å½±å“ã€‚

#### âœ… é˜¶æ®µå…­éªŒæ”¶æ¸…å•

- [ ] Cluster Autoscaler éƒ¨ç½²å·²åˆ›å»ºï¼ŒPod åœ¨ **kube-system** å‘½åç©ºé—´ä¸­å¤„äº Running çŠ¶æ€ï¼Œä¸” **ä¸ä¼šè¢«é©±é€**ï¼ˆå¸¦æœ‰ `cluster-autoscaler.kubernetes.io/safe-to-evict: "false"` æ³¨è§£ï¼‰ã€‚
- [ ] Cluster Autoscaler ä½¿ç”¨çš„ ServiceAccount å·²æ­£ç¡®å…³è” IRSAï¼šServiceAccount æ³¨è§£åŒ…å« eks-cluster-autoscaler è§’è‰² ARNï¼ŒAWS æ§åˆ¶å°ä¸­è¯¥è§’è‰²æœ€è¿‘çš„ **ä¿¡ä»»å…³ç³»** è°ƒç”¨æ—¶é—´å·²æ›´æ–°ï¼ˆè¡¨ç¤ºæœ‰é€šè¿‡ IRSA æˆåŠŸè°ƒç”¨ï¼‰ã€‚
- [ ] æŸ¥çœ‹ Autoscaler æ—¥å¿—ï¼Œç¡®è®¤å…¶**æ£€æµ‹åˆ° EKS èŠ‚ç‚¹ç»„**å¹¶å®šæœŸè¾“å‡ºæ‰«æä¿¡æ¯ï¼Œæ²¡æœ‰å‡ºç°æƒé™ä¸è¶³ç­‰é”™è¯¯ã€‚èƒ½å¤Ÿçœ‹åˆ° **Registered ASG** ç­‰æ—¥å¿—è¡Œï¼Œè¡¨æ˜é›†ç¾¤èŠ‚ç‚¹ç»„å·²è¢«æ¥ç®¡ç›‘æ§ã€‚
- [ ] è§¦å‘æ‰©å®¹/ç¼©å®¹æµ‹è¯•æ­£å¸¸ï¼šäººä¸ºåˆ¶é€  Pod Pending åï¼ŒAutoscaler å¯ä»¥åŠæ—¶å¢åŠ èŠ‚ç‚¹ï¼›ç§»é™¤è´Ÿè½½åï¼Œä¸€æ®µæ—¶é—´å†…è‡ªåŠ¨å‡å°‘ç©ºé—²èŠ‚ç‚¹ï¼ŒEKS æ§åˆ¶å°çš„ Node Group æ´»åŠ¨è®°å½•ä¸ Autoscaler æ—¥å¿—ç›¸ç¬¦ã€‚
- [ ] Autoscaler éƒ¨ç½²é…ç½®ç¬¦åˆä¼˜åŒ–è¦æ±‚ï¼šåŒ…æ‹¬ä½¿ç”¨äº†**AutoDiscovery**ï¼ˆé€šè¿‡ `--cluster-name` å®ç°ï¼Œæ— éœ€æ‰‹åŠ¨åˆ— ASGï¼‰ã€å¼€å¯äº† **balance-similar-node-groups** ä¿è¯ä¸åŒç±»å‹å®ä¾‹å‡è¡¡æ‰©å®¹ï¼Œé…ç½®äº† `--skip-nodes-with-system-pods=false` ä»¥å…è®¸ç¼©å®¹è‡³ 0 èŠ‚ç‚¹ï¼Œä»¥åŠé•œåƒç‰ˆæœ¬åŒ¹é…å½“å‰ K8s ç‰ˆæœ¬ç­‰ã€‚

---

## é˜¶æ®µä¸ƒï¼šç¯å¢ƒå…³åœä¸æ¸…ç†ï¼ˆå¯é€‰ï¼‰

> **æœ¬é˜¶æ®µå±äºå»¶ä¼¸æ“ä½œï¼ŒæŒ‡å¯¼å¦‚ä½•æ¯æ—¥æ¼”ç»ƒç»“æŸåå®‰å…¨åœ°å…³é—­æˆ–é”€æ¯èµ„æºã€‚** æ ¹æ®æˆæœ¬å’Œéœ€æ±‚ï¼Œå¯ä»¥é€‰æ‹©æš‚æ—¶åœæ­¢é«˜æˆæœ¬èµ„æºï¼Œæˆ–å½»åº•é”€æ¯ä»¥ç¡®ä¿ä¸‹æ¬¡æ¼”ç»ƒä»é›¶å¼€å§‹ã€‚

#### æ“ä½œç›®çš„ä¸èƒŒæ™¯

åœ¨å®Œæˆä¸€å¤©çš„ç»ƒä¹ åï¼Œä¸ºèŠ‚çœè´¹ç”¨ï¼Œéœ€è¦å¯¹äº‘ä¸Šèµ„æºè¿›è¡Œå…³åœå¤„ç†ã€‚æœ¬é¡¹ç›®æä¾›äº†ä¸¤ç§å…³åœç­–ç•¥ï¼š

- **åœæ­¢ï¼ˆStopï¼‰æ¨¡å¼**ï¼šä¿ç•™åŸºç¡€ç»“æ„ï¼ˆVPCã€å­ç½‘ã€å®‰å…¨ç»„ç­‰ï¼‰å’Œ Terraform çŠ¶æ€ï¼Œä»…å…³é—­é«˜æˆæœ¬èµ„æºå¦‚ NAT ç½‘å…³ã€ALBï¼Œå¹¶åˆ é™¤ EKS æ§åˆ¶é¢å’ŒèŠ‚ç‚¹ã€‚è¿™å¯ä»¥å¿«é€Ÿé‡Šæ”¾å¤§éƒ¨åˆ†èµ„æºå ç”¨ï¼ŒåŒæ—¶ä¿ç•™ç½‘ç»œä»¥ä¾›ä¸‹æ¬¡å¿«é€Ÿé‡å»ºã€‚
- **é”€æ¯ï¼ˆDestroyï¼‰æ¨¡å¼**ï¼šå½»åº•åˆ é™¤æ‰€æœ‰é€šè¿‡ Terraform å’Œ eksctl åˆ›å»ºçš„èµ„æºï¼ŒåŒ…æ‹¬ VPC æœ¬èº«ã€‚æ­¤æ¨¡å¼é€‚ç”¨äºéœ€è¦å®Œå…¨é‡ç½®ç¯å¢ƒæˆ–è€…ä¸å†ä½¿ç”¨æ—¶ã€‚**è­¦å‘Šï¼šé”€æ¯æ“ä½œä¸å¯æ¢å¤ï¼Œæ‰§è¡Œå‰è¯·ç¡®è®¤æ— å…¶ä»–ä¾èµ–ã€‚**

#### æ“ä½œæ­¥éª¤

**A. æ—¥å¸¸åœæ­¢æ¨¡å¼ï¼š**

1. **åœæ­¢é«˜æˆæœ¬èµ„æº (NAT, ALB)ï¼š** ä½¿ç”¨ Makefile æä¾›çš„å¿«æ·å‘½ä»¤æ‰§è¡Œ Terraform éƒ¨åˆ†å…³åœï¼š

   ```bash
   make stop
   ```

   è¯¥å‘½ä»¤å®è´¨è¿è¡Œäº† `terraform apply -var="create_nat=false" -var="create_alb=false" -var="create_eks=false"`ã€‚å®ƒä¼šå°† NAT Gateway å’Œ ALB ç›¸å…³èµ„æºåˆ é™¤æˆ–å…³é—­ï¼ŒåŒæ—¶ä¸å†ä¿ç•™ EKS ç›¸å…³çš„å¼¹æ€§ç½‘å¡å’Œè¾…åŠ©èµ„æºï¼ˆå› ä¸º `create_eks=false` å°†å¯¹åº” Terraform ç®¡ç†çš„èµ„æºè®¡å…¥é”€æ¯èŒƒå›´ï¼Œä½†ç”±äºæˆ‘ä»¬å·²å¯¼å…¥ cluster, nodegroupï¼Œè¿™é‡Œåº”è°¨æ…ï¼‰ã€‚

   **æ³¨æ„ï¼š**`make stop` å¹¶ä¸ä¼šåˆ é™¤ VPCã€æœ¬åœ°å­˜å‚¨ç­‰åŸºç¡€æ¶æ„ï¼Œåªæ˜¯æŠŠå¯å…³åœéƒ¨åˆ†åœæ‰ã€‚æ‰§è¡Œå®Œæˆåï¼Œå¯åœ¨ AWS æ§åˆ¶å°éªŒè¯ NAT Gateway æ˜¯å¦åˆ é™¤ï¼ˆåº”å˜ä¸º deleted çŠ¶æ€ï¼‰ï¼ŒALB æ˜¯å¦æ¶ˆå¤±ã€‚

1. **åˆ é™¤ EKS é›†ç¾¤æ§åˆ¶é¢ï¼š** NAT å’Œ ALB å…³åœåï¼Œä½¿ç”¨ eksctl åˆ é™¤ EKS é›†ç¾¤ï¼š

   ```bash
   make stop-cluster
   ```

   è¯¥å‘½ä»¤ç­‰ä»·æ‰§è¡Œ `eksctl delete cluster --name dev --region us-east-1`ã€‚eksctl å°†ä¼šåˆ é™¤æ§åˆ¶å¹³é¢ä»¥åŠèŠ‚ç‚¹ç»„ï¼ˆå°†è§¦å‘æ‰€æœ‰ EC2 å®ä¾‹å’Œç›¸å…³ Auto Scaling Group çš„å›æ”¶ï¼‰ã€‚ç”±äºæˆ‘ä»¬é€šè¿‡ IRSA åˆ›å»ºçš„ OIDC æä¾›å•†å’Œ IRSA è§’è‰²æ˜¯ç‹¬ç«‹èµ„æºï¼Œå®ƒä»¬**ä¸ä¼š**è¢« eksctl åˆ é™¤ï¼Œéœ€è¦ä¿ç•™ç”¨äºä¸‹æ¬¡é‡å»ºå¤ç”¨ï¼ˆå¦‚ä¸æƒ³ä¿ç•™å¯æ‰‹åŠ¨åˆ é™¤ OIDC æä¾›å•†ï¼‰ã€‚
   ç­‰å¾…å‘½ä»¤å®Œæˆï¼ŒEKS æ§åˆ¶å°ä¸­ dev é›†ç¾¤åº”æ¶ˆå¤±ã€‚æ­¤æ—¶ VPC ç­‰ä»åœ¨ï¼Œä½†ä¸äº§ç”Ÿäº§ç”Ÿè´¹ç”¨çš„èµ„æºå·²å…³åœã€‚

1. **ï¼ˆå¯é€‰ï¼‰æ ‡è®°åœæ­¢å®Œæˆ**ï¼šå¯ä»¥æ‰§è¡Œ `make clean` æ¸…ç†æœ¬åœ°ç¼“å­˜æ–‡ä»¶ï¼Œå¦‚ `.last-asg-bound` ç­‰ã€‚å¹¶è®°å½•ä¸‹å½“æ—¥æ“ä½œæ—¥å¿— `make logs` ä¾›äº‹ååˆ†æã€‚åˆ°æ­¤ï¼Œç¯å¢ƒå·²å®‰å…¨åœæ­¢ï¼Œæ¬¡æ—¥å¯é€šè¿‡ `make start` å’Œ `make start-cluster` å¿«é€Ÿé‡å¯é›†ç¾¤ã€‚

**B. å®Œå…¨é”€æ¯æ¨¡å¼ï¼š**

1. **ä¸€é”®é”€æ¯æ‰€æœ‰èµ„æºï¼š** è‹¥ç¡®å®šä¸å†ä¿ç•™ç¯å¢ƒï¼Œå¯ä½¿ç”¨ï¼š

   ```bash
   make destroy-all
   ```

   è¯¥å‘½ä»¤ä¼šè‡ªåŠ¨è°ƒç”¨ `stop-cluster` åˆ é™¤ EKS é›†ç¾¤ï¼Œç„¶åæ‰§è¡Œ `terraform destroy` é”€æ¯ Terraform åˆ›å»ºçš„æ‰€æœ‰èµ„æºã€‚åŒ…æ‹¬ VPCã€å­ç½‘ã€è·¯ç”±è¡¨ã€å®‰å…¨ç»„ã€ä»¥åŠé€šè¿‡ Terraform ç®¡ç†çš„ IAM è§’è‰²ã€OIDC æä¾›å•†ç­‰éƒ½ä¼šè¢«åˆ é™¤ã€‚è¯·è°¨æ…è¿è¡Œæ­¤å‘½ä»¤ï¼Œå¹¶ç¡®ä¿ Terraform çŠ¶æ€ä¸­æ²¡æœ‰éæœ¬ç»ƒä¹ èŒƒå›´çš„èµ„æºï¼Œä»¥å…è¯¯åˆ ã€‚

1. **æ¸…ç†æ®‹ç•™å’ŒçŠ¶æ€**ï¼šå¦‚æœ destroy-all æ‰§è¡ŒæˆåŠŸï¼ŒAWS ä¸Šåº”ä¸å†æœ‰æ¼”ç»ƒåˆ›å»ºçš„ä»»ä½•èµ„æºã€‚æ‚¨å¯ä»¥æ£€æŸ¥ S3 Bucket ä¸­ Terraform çŠ¶æ€æ–‡ä»¶æ˜¯å¦ä»å­˜åœ¨ï¼Œé€šå¸¸ destroy ä¸ä¼šè‡ªåŠ¨åˆ é™¤çŠ¶æ€æ–‡ä»¶ï¼Œå¯æ ¹æ®ç­–ç•¥é€‰æ‹©ä¿ç•™æˆ–æ‰‹åŠ¨åˆ é™¤ã€‚DynamoDB é”è¡¨è®°å½•ä¹Ÿå¯æ¸…ç†ã€‚æœ€åï¼Œè¿è¡Œ `aws sso logout` æ³¨é”€ä¼šè¯ä»¥ç¡®ä¿è´¦å·å®‰å…¨ã€‚

#### éªŒè¯å‘½ä»¤ä¸é¢„æœŸè¾“å‡º

- **åœæ­¢æ¨¡å¼éªŒè¯ï¼š** æ‰§è¡Œ `make stop` åï¼ŒTerraform æ—¥å¿—åº”æ˜¾ç¤º `-/+` æˆ– `-` æ“ä½œé’ˆå¯¹ NAT Gatewayã€ALB ç­‰èµ„æºï¼ˆé”€æ¯æˆ–ä¿®æ”¹ä¸º falseï¼‰ã€‚å®Œæˆåï¼Œç”¨ AWS CLI `describe-nat-gateways` åº”ä¸å†è¿”å› NAT Gatewayï¼Œ`describe-load-balancers` ä¹ŸæŸ¥è¯¢ä¸åˆ° lab-albã€‚æ‰§è¡Œ `make stop-cluster`ï¼Œeksctl ä¼šè¾“å‡ºåˆ é™¤è¿›åº¦ï¼ŒåŒ…æ‹¬ CloudFormation stack åˆ é™¤å®Œæˆä¿¡æ¯ï¼Œæœ€ç»ˆæç¤ºé›†ç¾¤åˆ é™¤æˆåŠŸã€‚EKS æ§åˆ¶å°åˆ·æ–°åº”çœ‹ä¸åˆ° dev é›†ç¾¤ã€‚
- **é”€æ¯æ¨¡å¼éªŒè¯ï¼š** `make destroy-all` å®Œæˆåï¼ŒTerraform ä¼šè¾“å‡ºæ¯ä¸ªèµ„æºé”€æ¯å®Œæˆçš„æç¤ºï¼Œæœ€ç»ˆ `Destroy complete!`ã€‚å†æ¬¡é€šè¿‡ AWS CLI/æ§åˆ¶å°æ£€æŸ¥ VPCã€å­ç½‘ã€Security Group å‡å·²ä¸å­˜åœ¨ã€‚IAM æ§åˆ¶å°ä¸­ eks-cluster-autoscaler è§’è‰²ã€OIDC Provider ä¹Ÿåº”åˆ é™¤ï¼ˆå¦‚ Terraform æœ‰ç®¡ç†è¿™äº›ï¼‰ã€‚S3 Bucket ä¸­ Terraform state å¯æ‰‹åŠ¨éªŒè¯æˆ–ä¸‹è½½å¤‡ä»½ï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´ã€‚

#### å¸¸è§é”™è¯¯æç¤ºä¸è§£å†³åŠæ³•ï¼ˆTroubleshootingï¼‰

- **Terraform destroy å¤±è´¥ï¼š** å¦‚æœåœ¨ destroy é˜¶æ®µ Terraform æç¤ºåˆ é™¤æŸäº›èµ„æºå¤±è´¥ï¼Œå¯èƒ½æ˜¯ä¾èµ–é¡ºåºé—®é¢˜æˆ–æ®‹ç•™ä¾èµ–ã€‚ä¾‹å¦‚ EKS é›†ç¾¤æœªåˆ å¹²å‡€é€ æˆ VPC åˆ ä¸æ‰ï¼Œå¯é‡è¯•æ‰§è¡Œ `terraform destroy` å†æ¬¡å°è¯•ã€‚æˆ–è€…é€šè¿‡ AWS æ§åˆ¶å°æ£€æŸ¥æ˜¯å¦æœ‰èµ„æºéœ€è¦å…ˆæ‰‹å·¥åˆ é™¤ï¼ˆå¦‚ç•™å­˜çš„ ENIã€EC2 ç­‰ï¼‰ã€‚

- **`make stop` å¼•å‘æ„å¤–åˆ é™¤ï¼š** ç”±äºæˆ‘ä»¬å°† `create_eks` è®¾ç½®ä¸º false ä»¥åœç”¨ EKS ç›¸å…³ Terraform èµ„æºï¼Œä½†æˆ‘ä»¬å¯¼å…¥äº† EKS é›†ç¾¤/èŠ‚ç‚¹ç»„ï¼Œè¿™é‡Œå¯èƒ½äº§ç”Ÿæ··ä¹±ã€‚å®è·µä¸­å»ºè®®ä¸å¯¹æ­£åœ¨å¯¼å…¥ç®¡ç†çš„ EKS èµ„æºä½¿ç”¨ terraform å‰Šå‡æ“ä½œï¼Œè€Œæ˜¯ä»… stop NAT/ALB å³å¯ã€‚

  - **ğŸ’¡ ä¿®å¤å»ºè®®ï¼š** å¼•å…¥ä¸€ä¸ªä¸“é—¨çš„ make ç›®æ ‡ï¼ˆä¾‹å¦‚ `make stop-nat-alb`ï¼‰åªå…³åœ NAT å’Œ ALBï¼Œä¸æ¶‰åŠ EKS èµ„æºï¼Œä»¥é¿å… Terraform è¯•å›¾é”€æ¯ EKS ç›¸å…³çŠ¶æ€ã€‚æ­¤å¤–ï¼ŒMakefile ä¸­æåˆ°çš„ `stop-hard` ç›®æ ‡ç›®å‰æœªå®ç°, å»ºè®®è¡¥å……å¯¹åº”è§„åˆ™ä»¥è‡ªåŠ¨è°ƒç”¨ stop å’Œ eksctl deleteã€‚ä¾‹å¦‚ï¼š

  ```make
  stop-hard: stop
  	eksctl delete cluster --name $(CLUSTER) --region $(REGION) --profile $(AWS_PROFILE) || true
  ```

  è¿™æ ·å¯ä¸€é”®æ‰§è¡Œå®Œå…¨åœæ­¢æµç¨‹ã€‚

- **èµ„æºæ®‹ç•™æ”¶è´¹ï¼š** åœæ­¢æ¨¡å¼ä¸‹ï¼ŒVPC å’ŒæŸäº›å°‘é‡èµ„æºä¿ç•™ä¸ä¼šäº§ç”Ÿæˆæœ¬ã€‚ä½†å¦‚æœæ‚¨çš„ Hosted Zone å’Œ DynamoDB é”è¡¨ç­‰é•¿æ—¶é—´ä¸ç”¨ï¼Œä¹Ÿå¯é€‰æ‹©åˆ é™¤ä»¥èŠ‚çœæå°æˆæœ¬ã€‚ç•™æ„ AWS Cost Explorerï¼Œç¡®ä¿æ— é—ç•™æ˜‚è´µèµ„æºï¼ˆå¦‚ EIP æ²¡æœ‰é‡Šæ”¾ä¼šäº§ç”Ÿå°‘é‡é—²ç½®è´¹ç”¨ï¼‰ã€‚

- **é‡å¤ç¯å¢ƒå†²çªï¼š** å¦‚æœæ‚¨æ¯æ—¥é‡å»ºï¼Œä¸é”€æ¯ VPCï¼Œåˆ™ VPC ID ä¿æŒä¸å˜ï¼ŒRouteÂ 53 è®°å½•ä¹Ÿä¸€ç›´å­˜åœ¨ï¼Œæ— éœ€æ¯å¤©æ”¹ã€‚ä½†è‹¥æ›¾é”€æ¯åˆé‡å»ºï¼Œç•™æ„æ›´æ–° eksctl YAML å’Œ DNS ç­‰é…ç½®ä¸ºæ–°èµ„æºã€‚å¯¼å…¥è„šæœ¬ã€Terraform é…ç½®é‡Œçš„ ID ä¹Ÿè¦ç›¸åº”æ›´æ–°ã€‚ä¿æŒå„é˜¶æ®µè„šæœ¬å’Œé…ç½®å‚æ•°åŒæ­¥å¯¹é‡å¤æ¼”ç»ƒéå¸¸é‡è¦ã€‚

#### âœ… é˜¶æ®µä¸ƒéªŒæ”¶æ¸…å•

- [ ] æ‰§è¡Œ **åœæ­¢æ¨¡å¼** åï¼šNAT Gatewayã€ALB å·²åˆ é™¤ï¼ŒEKS é›†ç¾¤ä¸èŠ‚ç‚¹ç»„å·²åˆ é™¤ä½† VPC ç­‰åŸºç¡€ç»“æ„ä»åœ¨ã€‚AWS è´¦æˆ·ä¸å†æœ‰æŒç»­è®¡è´¹çš„è®¡ç®—/ç½‘ç»œèµ„æºï¼Œé›†ç¾¤çŠ¶æ€ä¸º**å·²åˆ é™¤**ã€‚
- [ ] å‡†å¤‡ç¬¬äºŒå¤©é‡å»ºï¼šä¿ç•™çš„ VPC å’Œ Terraform çŠ¶æ€ç­‰éªŒè¯æ­£ç¡®ï¼Œæ— æ„å¤–å˜åŠ¨ã€‚ä¸‹æ¬¡æ‰§è¡Œ `make start && make start-cluster` èƒ½åœ¨åŸ VPC ä¸Šé‡æ–°åˆ›å»ºç›¸åŒé…ç½®çš„é›†ç¾¤ï¼Œå®ç°é…ç½®å¤ç”¨ã€‚
- [ ] æ‰§è¡Œ **é”€æ¯æ¨¡å¼** åï¼šæœ¬æ¼”ç»ƒæ¶‰åŠçš„æ‰€æœ‰ AWS èµ„æºå‡åˆ é™¤ï¼Œæ— æ®‹ç•™ã€‚S3 ä¸Š Terraform çŠ¶æ€å¯å¤‡ä»½åˆ é™¤ã€‚ç¡®è®¤äº‘ä¸Šä¸å†äº§ç”Ÿä»»ä½•è´¹ç”¨ã€‚
- [ ] Makefile è„šæœ¬æ”¹è¿›å»ºè®®å·²ç»è®°å½•æˆ–å®æ–½ï¼Œå¦‚å¢åŠ  **stop-hard** è§„åˆ™ä¾¿äºä¸€é”®å½»åº•å…³åœã€é¿å… Terraform åœæ­¢æ—¶å¹²æ‰°å¯¼å…¥èµ„æºç­‰ï¼Œæå‡æ¯æ—¥æ¼”ç»ƒæµç¨‹çš„å¯é æ€§å’Œä¾¿åˆ©æ€§ã€‚
- [ ] æ•´ä¸ªæ¯æ—¥æ¼”ç»ƒæµç¨‹ï¼ˆé˜¶æ®µä¸€è‡³ä¸ƒï¼‰æ„æˆé—­ç¯ï¼Œæ‚¨å·²ç»èƒ½å¤Ÿåœ¨ä¸€å¤©å†…ä»æ— åˆ°æœ‰éƒ¨ç½²å‡ºå®Œæ•´çš„äº‘åŸç”Ÿç¯å¢ƒï¼Œå¹¶åœ¨ç»“æŸæ—¶å®‰å…¨åœ°å°†å…¶æ‹†é™¤ã€‚æ¼”ç»ƒè¿‡ç¨‹ä¸­çš„é—®é¢˜ä¹Ÿéƒ½å¾—åˆ°è§£å†³ï¼Œä¸ºå°†æ¥çš„è‡ªåŠ¨åŒ–å’Œå¤§è§„æ¨¡éƒ¨ç½²æ‰“ä¸‹åŸºç¡€ã€‚ç¥è´ºæ‚¨å®Œæˆæ¯æ—¥æ¼”ç»ƒï¼
